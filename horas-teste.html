<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oração do Dia — Teste</title>
  <meta name="theme-color" content="#f3e6cf">

  <style>
    :root{
      --gap: 8px;
      --btn-wide: 77.3%;
      --btn-pad-v: 6px;
      --btn-pad-h: 11px;
      --vermelho:#a00000;
      --dourado:#d6b25a;
      --laranja:#ff7a00;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Arial,Helvetica,sans-serif;color:#1b1b1b;
      background:#f3e6cf;
      background-image:
        repeating-linear-gradient(45deg,rgba(160,0,0,0.22) 0,rgba(160,0,0,0.22) 2px,transparent 2px,transparent 40px),
        repeating-linear-gradient(-45deg,rgba(160,0,0,0.22) 0,rgba(160,0,0,0.22) 2px,transparent 2px,transparent 40px);
      background-size:40px 40px;display:flex;flex-direction:column;min-height:100vh
    }
    a,a:visited,a:hover,a:active{ text-decoration:none; color:inherit; }
    header.top{ text-align:center; padding:4px 8px 0 }
    .title{
      color:var(--dourado); font-weight:800; font-size:2.15rem; margin:2px 0 4px;
      -webkit-text-stroke:1px var(--laranja); text-shadow:0 0 1px var(--laranja),0 0 1px var(--laranja)
    }
    .wrap{ width:100%; max-width:620px; margin:0 auto; padding:4px 16px 16px; position:relative; }
    .hero{
      display:block; margin:4px auto 8px; max-width:100%; height:auto; max-height:420px;
      border:6px solid var(--laranja);
      box-shadow: 0 0 0 4px var(--dourado), 0 0 0 4px var(--dourado) inset;
      border-radius:12px
    }
    .hero[hidden]{ display:none }
    .chip{
      display:inline-block; margin:6px 0 8px; padding:8px 12px; background:rgba(255,255,255,0.9);
      border:3px solid var(--laranja); box-shadow:0 0 0 2px var(--dourado) inset; border-radius:14px; font-weight:bold; color:var(--vermelho)
    }
    .datebar{ display:flex; align-items:center; justify-content:center; gap:10px; margin:8px auto 16px }
    .datebtn{
      background:#fff; border:2px solid var(--laranja); border-radius:20px;
      padding:3px 22px;
      font-size:0.58rem;
      color:#7a0000; cursor:pointer; transition:.2s
    }
    .datebtn:hover{ background:#fff3da; transform:translateY(-1px) }
    .datedisplay{ min-width:156px; text-align:center; color:#582c0c; line-height:1.2 }
    .datedisplay .date{ font-weight:700 }
    .datedisplay .weekday{ font-size:.95rem; color:#7a5c3a; text-transform:lowercase }
    .col{ display:flex; flex-direction:column; align-items:center }
    .btn{
      display:inline-flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;
      background:rgba(255,255,255,0.97); border:1.35px solid var(--laranja);
      box-shadow:0 0 0 0.9px var(--dourado) inset, 0 4px 10px rgba(0,0,0,0.15);
      border-radius:18px; font-size:.86rem; font-weight:bold;
      text-align:center; position:relative; transition:.2s; color:var(--vermelho);
      margin: var(--gap) 0;
    }
    .btn:hover{ transform:scale(1.02); background:#fff3da }
    .btn img{ position:absolute; left:10px; width:20px; height:20px }
    .label{ width:100%; text-align:center; pointer-events:none }
    .line1{ display:block; color:var(--vermelho) }
    .line2{ display:block; color:#000; font-size:.9em }
    .tall{ width: var(--btn-wide); max-width: 780px; padding: var(--btn-pad-v) var(--btn-pad-h); }
    .btn.sinaxarion{ padding: calc(var(--btn-pad-v) * 1.4) var(--btn-pad-h) }
    .wide-wrap{ margin-top: 10px; margin-bottom: 0; display:flex; justify-content:center; align-items:center; }
    .btn.calendar{ width: var(--btn-wide); max-width:780px; padding: calc(var(--btn-pad-v) * 1.4) var(--btn-pad-h) }
    footer{ margin-top: 0; text-align:center; font-size:.85rem; color:#7a6a55; padding:0 8px 8px }
    .back{
      display:inline-flex; align-items:center; gap:8px; background:var(--vermelho); color:#fff;
      border:1px solid #6f0000; padding:.32rem .56rem; border-radius:9px;
      font-weight:bold; font-size:.9rem; transform:scale(.51); transform-origin:center; text-decoration:none;
      margin: 2px auto 0;
    }
    #toast{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
      background:#222; color:#fff; padding:10px 14px; border-radius:10px; font-size:.9rem;
      opacity:0; pointer-events:none; transition:.2s
    }
    .hint-arrow{
      position:absolute; top: 48%; transform: translateY(-50%); font-size:36px; line-height:1;
      color:var(--vermelho); font-weight:900; text-shadow:0 0 6px rgba(0,0,0,.18);
      animation: hintBlink .6s ease-in-out 4 forwards; pointer-events:none; z-index: 5; user-select:none;
    }
    .hint-left{ left: -6px; }
    .hint-right{ right: -6px; }
    @keyframes hintBlink{ 0%, 100% { opacity: 0; transform: translateY(-50%) translateZ(0); } 50% { opacity: 1; transform: translateY(-45%) translateZ(0); } }
    @media (max-width: 420px){
      .hint-left{ left: -2px; } .hint-right{ right: -2px; } .hint-arrow{ font-size:30px; }
    }
  </style>
</head>
<body>
  <header class="top"><h1 class="title">Oração do Dia</h1></header>

  <main class="wrap">
    <div class="hint-arrow hint-left" aria-hidden="true">↓</div>
    <div class="hint-arrow hint-right" aria-hidden="true">↓</div>

    <img class="hero" id="hero" src="img/icone-horas.jpg" alt="Ícone"
         onerror="this.hidden=true;document.getElementById('hero-chip').style.display='inline-block';">
    <div id="hero-chip" class="chip" style="display:none">Oração do Dia</div>

    <div class="datebar">
      <button class="datebtn" id="btn-prev">◀ Anterior</button>
      <div class="datedisplay">
        <div class="date" id="date-text">--/--/----</div>
        <div class="weekday" id="weekday-text">--</div>
      </div>
      <button class="datebtn" id="btn-next">Próximo ▶</button>
    </div>

    <div class="col" id="col"></div>

    <div class="wide-wrap">
      <a class="btn calendar" id="btn-cal">
        <img src="img/cruz3.png" alt="">
        <span class="label"><span class="line1">Calendário Litúrgico</span></span>
      </a>
    </div>
  </main>

  <div id="toast"></div>

  <footer>
    <a class="back" href="oracao.html">← Voltar</a>
  </footer>

  <script>
    /* ===================== CSVs PUBLICADOS ===================== */
    const HORAS_REFS_CSV_URL = 'https://docs.google.com/spreadsheets/d/SEU_ID/export?format=csv'; // aba horas-refs
    /* =========================================================== */

    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.opacity=1; clearTimeout(window.__tid); window.__tid=setTimeout(()=>t.style.opacity=0,2000); }
    const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();
    function toISO(d){ const s=(d||'').replace(/[-.]/g,'/').trim(); const parts=s.split('/'); if(parts.length!==3) return null; if(parts[0].length===4){ const [y,m,da]=parts; return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${da.padStart(2,'0')}`; } const [da,m,y]=parts; return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${da.padStart(2,'0')}`; }
    function fmtBR(d){ return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'}); }
    function fmtISO(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
    function parseCSV(text){
      const rows=[]; let i=0, cur=[], val='', q=false;
      while(i<text.length){
        const c=text[i++]; if(q){ if(c==='"' && text[i]==='"'){ val+='"'; i++; } else if(c==='"'){ q=false; } else val+=c; }
        else{ if(c===','){ cur.push(val); val=''; } else if(c==='"'){ q=true; }
          else if(c==='\n'){ cur.push(val); rows.push(cur); cur=[]; val=''; }
          else if(c!=='\r'){ val+=c; } }
      }
      if(val.length||cur.length) { cur.push(val); rows.push(cur); }
      return rows;
    }
    async function fetchCSV(url){
      const cb = Math.floor(Date.now()/60000);
      const u1 = url + (url.includes('?')?'&':'?') + 'cb='+cb;
      try{ const r=await fetch(u1,{mode:'cors'}); if(!r.ok) throw new Error(r.status); return await r.text(); }
      catch(e){ const prox='https://api.allorigins.win/raw?url='+encodeURIComponent(u1); const r=await fetch(prox); if(!r.ok) throw new Error('fallback '+r.status); return await r.text(); }
    }
    function findCol(header, candidates){ for(const c of candidates){ const i=header.indexOf(norm(c)); if(i>=0) return i; } return -1; }

    /* ======= horas-refs ======= */
    let _refsRows=null, _refsHeader=null;
    async function ensureRefs(){
      if(_refsRows) return;
      toast('Carregando referências…');
      const txt = await fetchCSV(HORAS_REFS_CSV_URL);
      const rows = parseCSV(txt).filter(r=>r.length && r.join('').trim()!=='');
      const header = rows.shift().map(h=>norm(h));
      _refsHeader=header; _refsRows=rows;
    }
    async function openRefs(kind, turno, dateObj){
      // kind: 'synaxarion' | 'salmo'
      await ensureRefs();
      const h=_refsHeader, rs=_refsRows;
      const iDate = findCol(h, ['date','data','dia']);
      const iType = findCol(h, ['item_type','tipo','item']);
      const iTurno= findCol(h, ['turno','periodo','período']);
      const iLab  = findCol(h, ['label','rotulo','rótulo']);
      const iUrl  = findCol(h, ['url','link','doc','arquivo','link_doc']);
      const iEn   = findCol(h, ['enabled','publicado','ativo']);
      if([iDate,iType,iUrl].some(x=>x<0)){ toast('Planilha horas-refs: cabeçalhos ausentes'); return; }
      const todayBR = fmtBR(dateObj);  const todayISO = toISO(todayBR);
      const alvoT = norm(turno||'');
      const row = rs.find(r=>{
        const d=(r[iDate]||'').trim();
        const typeOK = norm(r[iType])===norm(kind);
        const dateOK = (toISO(d)===todayISO) || (d===todayBR);
        const turnOK = iTurno>=0 ? (alvoT? norm(r[iTurno])===alvoT : true) : true;
        const enOK   = iEn>=0 ? String(r[iEn]).trim()==='1' : true;
        return typeOK && dateOK && turnOK && enOK;
      });
      if(!row){ toast('Sem referência para esta data.'); return; }
      const link=(row[iUrl]||'').trim(); if(!link){ toast('Link vazio.'); return; }
      window.open(link,'_blank');
    }

    /* ======= UI ======= */
    function mkLink(href,l1,l2=''){
      const a=document.createElement('a');
      a.href=href; a.className='btn tall';
      a.innerHTML=`<img src="img/cruz3.png" alt=""><span class="label">
        <span class="line1">${l1}</span>${l2?`<span class="line2">${l2}</span>`:''}
      </span>`;
      return a;
    }
    function mkAction(label1,label2,onclick){
      const a=document.createElement('a');
      a.href='#'; a.className='btn tall';
      a.innerHTML=`<img src="img/cruz3.png" alt=""><span class="label">
        <span class="line1">${label1}</span>${label2?`<span class="line2">${label2}</span>`:''}
      </span>`;
      a.addEventListener('click', (e)=>{ e.preventDefault(); onclick(); });
      return a;
    }

    // data selecionada (default: hoje)
    let currentDate=new Date();
    const urlD = new URLSearchParams(location.search).get('d');
    if(urlD && /^\d{4}-\d{2}-\d{2}$/.test(urlD)){
      const [Y,M,D]=urlD.split('-'); currentDate=new Date(Number(Y),Number(M)-1,Number(D));
    }
    function formatDateBR(d){return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'})}
    function weekdayBR(d){return d.toLocaleDateString('pt-BR',{weekday:'long'})}
    function updateDateBar(){
      document.getElementById('date-text').textContent=formatDateBR(currentDate);
      const wd = weekdayBR(currentDate);
      document.getElementById('weekday-text').textContent = wd.charAt(0).toUpperCase()+wd.slice(1);
      mountButtons(); // re-render para atualizar os ?d=...
    }
    document.getElementById('btn-prev').addEventListener('click',()=>{currentDate.setDate(currentDate.getDate()-1);updateDateBar();});
    document.getElementById('btn-next').addEventListener('click',()=>{currentDate.setDate(currentDate.getDate()+1);updateDateBar();});

    function mountButtons(){
      const c=document.getElementById('col'); c.innerHTML='';
      const d = fmtISO(currentDate);

      // filhos recebem a data ?d=YYYY-MM-DD
      c.append(mkLink(`safro-hora.html?from=horas&d=${d}`,'Safro','oração da manhã'));
      c.append(mkAction('Salmo do Dia e Leitura','manhã', ()=>openRefs('salmo','manha', currentDate)));
      c.append(mkLink(`terca-hora.html?from=horas&d=${d}`,'Hora Terça','9 horas'));
      c.append(mkLink(`sexta-hora.html?from=horas&d=${d}`,'Hora Sexta','12 horas'));
      c.append(mkLink(`nona-hora.html?from=horas&d=${d}`,'Hora Nona','15 horas'));

      // Synaxarion agora abre o .doc do dia
      c.append(mkAction('Synaxarion','', ()=>openRefs('synaxarion','', currentDate)));

      c.append(mkLink(`ramsho-hora.html?from=horas&d=${d}`,'Ramsho','oração da tarde'));
      c.append(mkAction('Salmo do Dia e Leitura','tarde', ()=>openRefs('salmo','tarde', currentDate)));
      c.append(mkLink(`sutoro-hora.html?from=horas&d=${d}`,'Sutoro','oração da noite'));
      c.append(mkLink(`lilyo-hora.html?from=horas&d=${d}`,'Lilyo','vigílias'));

      // Calendário preserva origem
      const btnCal = document.getElementById('btn-cal');
      btnCal.href = 'calendario.html?from=horas';
    }

    updateDateBar();

    document.getElementById('hero').addEventListener('load',()=>{document.getElementById('hero-chip').style.display='none';});
    for(const el of document.querySelectorAll('.hint-arrow')){ el.addEventListener('animationend', ()=>{ el.remove(); }, { once:true }); }
  </script>
</body>
</html>
