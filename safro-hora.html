<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Safro — Oração da Manhã</title>
<meta name="theme-color" content="#243e6b">

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="img/app-icon-180.png">
<link rel="icon" href="img/favicon-32.png" sizes="32x32">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

  
<style>
  :root{
    --azul-topo:#0a1d3d; --azul-meio:#243e6b; --amarelo-base:#ffe680; --amarelo-brilho:#ffd23a; --sol:#ffe45e;
    --dourado:#b08d3b; --vermelho:#a00000; --sombra:rgba(0,0,0,.18); --fonte: Arial, Helvetica, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:var(--fonte); color:#111;
    background-image:
      radial-gradient(#ffffff 1px, transparent 1.8px),
      radial-gradient(rgba(255,255,255,.85) 1.2px, transparent 2px),
      radial-gradient(circle at 15% 82%, #fff9b8 0%, var(--sol) 32%, rgba(255,228,94,0) 62%),
      linear-gradient(to top, var(--amarelo-base) 0%, var(--amarelo-brilho) 24%, #2e518b 50%, var(--azul-meio) 70%, var(--azul-topo) 100%);
    background-size:160px 160px,220px 220px,cover,100% 100%;
    background-position:0 0,60px 80px,center,center;
    background-attachment: fixed, fixed, scroll, scroll;
    min-height:100vh; display:flex; flex-direction:column;
  }
  header{ position:relative; z-index:1; text-align:center; padding:20px 12px 8px; background:linear-gradient(to bottom, rgba(255,234,166,.35) 0%, rgba(10,29,61,0) 100%); }
  .titulo{ margin:0; line-height:1.05; font-weight:900; letter-spacing:.6px; font-size:36px; color:#ffe680; -webkit-text-stroke:1.5px var(--dourado); text-shadow:0 1px 0 rgba(0,0,0,.12); }
  .sub{ margin-top:6px; font-size:19px; color:#fff; font-weight:600; }
  .hero-icon{ display:block; margin:14px auto 8px; max-width:clamp(288px, 80vw, 512px); width:100%; height:auto; object-fit:contain; object-position:center; border:0; border-radius:0; box-shadow:0 6px 18px var(--sombra); background:transparent; }

  .wrap{ position:relative; z-index:1; max-width:620px; margin:40px auto 24px; padding:0 16px; display:flex; flex-direction:column; gap:10px; align-items:center; flex:1; }
  .btn{
    position:relative; display:flex; align-items:center; justify-content:flex-start; text-decoration:none; background:#fff;
    border:2px solid var(--dourado); border-radius:14px; width:55%; min-width:280px; padding:6px 12px; min-height:51px;
    box-shadow:0 4px 10px var(--sombra); color:#101010; font-weight:800; text-align:center; transition:transform .08s, box-shadow .12s; overflow:hidden;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 14px var(--sombra); }
  .btn .icon-round{ width:32px; height:32px; border-radius:50%; object-fit:cover; border:2px solid var(--dourado); box-shadow:0 0 0 2px #fff inset; background:#fff; margin-right:10px; flex:0 0 auto; }
  .btn .label{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:2px; pointer-events:none; text-align:center; }
  .btn .main{ font-size:21px; line-height:1.06; -webkit-text-stroke:.8px var(--dourado); }
  .btn .sub{ font-size:15px; line-height:1.04; font-weight:700; color:#0a1d3d; -webkit-text-stroke:0; }

  footer{ text-align:center; margin:8px 0 28px }
  .btn-voltar{
    display:inline-flex; align-items:center; gap:8px; background:var(--vermelho); color:#fff; text-decoration:none; border:none; border-radius:999px; padding:6px 12px;
    font-weight:800; font-size:12px; box-shadow:0 3px 8px var(--sombra); transform:scale(.6); transform-origin:center;
  }
  #toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#222; color:#fff; padding:9px 14px; border-radius:10px; font-size:.9rem; opacity:0; pointer-events:none; transition:.2s}
</style>
</head>
<body>
  <header>
    <h1 class="titulo">SAFRO</h1>
    <div class="sub">Oração da Manhã</div>
    <img class="hero-icon" src="img/icone-safro.horas.jpg" onerror="this.onerror=null;this.src='img/cedro.jpg';" alt="Ícone principal de Safro">
  </header>

  <main class="wrap">
    <a id="btn-curta" href="#" class="btn" aria-disabled="true" title="Link não configurado">
      <img class="icon-round" src="img/cedro.jpg" alt="Cedro">
      <span class="label"><span class="main">Safro</span><span class="sub">versão curta</span></span>
    </a>

    <a id="btn-longa" href="#" class="btn" aria-disabled="true" title="Link não configurado">
      <img class="icon-round" src="img/cedro.jpg" alt="Cedro">
      <span class="label"><span class="main">Safro</span><span class="sub">versão longa</span></span>
    </a>

    <a id="btn-hinos" href="#" class="btn" aria-disabled="true" title="Link não configurado">
      <img class="icon-round" src="img/cedro.jpg" alt="Cedro">
      <span class="label"><span class="main">Hinos e Melodias</span></span>
    </a>
  </main>

  <footer>
    <a class="btn-voltar" id="backLink" href="horas-teste.html"><span class="seta">←</span>voltar</a>
  </footer>

  <div id="toast"></div>

<script>
/* ====== CONFIG ====== */
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=970478871&single=true&output=csv';
const PAGE_SLUG = 'safro';

/* ====== HELPERS ====== */
const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();

// aceita DDMMAAAA, DD/MM/AAAA, AAAA-MM-DD etc.
function toISOfromCSV(val){
  const s=(val||'').toString().trim();
  if(!s) return null;

  if(/^\d{8}$/.test(s)){ // DDMMAAAA
    const dd=s.slice(0,2), mm=s.slice(2,4), yyyy=s.slice(4,8);
    return `${yyyy}-${mm}-${dd}`;
  }

  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  const t=s.replace(/[-.]/g,'/');
  const p=t.split('/');
  if(p.length===3){
    if(p[0].length===4){
      const[y,m,d]=p;
      return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }else{
      const[d,m,y]=p;
      return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
  }
  return null;
}

function todayISO(){
  const d=new Date(),y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function q(name){return new URLSearchParams(location.search).get(name)}
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.opacity=1;
  clearTimeout(window.__tid); window.__tid=setTimeout(()=>t.style.opacity=0,2200);
}

/* TOLERÂNCIA DE CHAVES */
function keyAlias(kRaw){
  const k = norm(kRaw).replace(/[^\w- ]/g,'');
  if (/\bversao\b.*\blonga\b/.test(k) ||
      /\bversao[- ]?longa\b/.test(k) ||
      /\bsafro[- ]?longa\b/.test(k) ||
      /\blonga\b/.test(k) ||
      /\blong\b/.test(k)) {
    return 'versao-longa';
  }
  if (/\bversao\b.*\bcurta\b/.test(k) ||
      /\bversao[- ]?curta\b/.test(k) ||
      /\bsafro[- ]?curta\b/.test(k) ||
      /\bcurta\b/.test(k) ||
      /\bshort\b/.test(k) ||
      /\bbreve\b/.test(k)) {
    return 'versao-curta';
  }
  if (/\bhinos?\b/.test(k) ||
      /\bmelodias?\b/.test(k) ||
      /\bhinos[- ]?melodias\b/.test(k) ||
      /\bhymns?\b/.test(k) ||
      /\bchants?\b/.test(k)) {
    return 'hinos-melodias';
  }
  return k;
}

function parseCSV(t){
  const r=[];let i=0,c=[],v='',q=false;
  while(i<t.length){
    const ch=t[i++];
    if(q){
      if(ch=='"'&&t[i]=='"'){v+='"';i++;}
      else if(ch=='"'){q=false;}
      else v+=ch;
    }else{
      if(ch===','){c.push(v);v='';}
      else if(ch=='"'){q=true;}
      else if(ch=='\n'){c.push(v);r.push(c);c=[];v='';}
      else if(ch!=='\r'){v+=ch;}
    }
  }
  if(v.length||c.length){c.push(v);r.push(c);}
  return r;
}

async function fetchCSV(u){
  const cb=Math.floor(Date.now()/60000);
  const u1=u+(u.includes('?')?'&':'?')+'cb='+cb;
  try{
    const r=await fetch(u1);
    if(!r.ok) throw new Error(r.status);
    return await r.text();
  }catch(e){
    const p='https://api.allorigins.win/raw?url='+encodeURIComponent(u1);
    const r=await fetch(p);
    if(!r.ok) throw new Error('fallback '+r.status);
    return await r.text();
  }
}

function setBtnState(a, url){
  if(url){
    a.href=url; a.target='_blank';
    a.removeAttribute('aria-disabled');
    a.style.opacity='1'; a.style.pointerEvents='auto'; a.title='';
  }else{
    a.href='#'; a.target='';
    a.setAttribute('aria-disabled','true');
    a.style.opacity='.45'; a.style.pointerEvents='none'; a.title='Link não configurado';
  }
}

/* ====== BOOT ====== */
(async function(){
  const raw = q('d') || q('data');
  const iso = raw ? (toISOfromCSV(raw) || todayISO()) : todayISO();

  document.getElementById('backLink').href = `horas-teste.html?d=${iso}`;

  try{
    const txt = await fetchCSV(SHEET_URL);
    const rows = parseCSV(txt).filter(r=>r.join('').trim()!=='');
    const head = rows.shift().map(h=>norm(h));
    const idx = nms => nms.map(n=>head.indexOf(norm(n))).find(i=>i>=0);

    const iDate=idx(['date','data','dia']);
    const iSlug=idx(['page_slug','pagina','page']);
    const iKey =idx(['option_key','key','opcao','opção']);
    const iLab =idx(['label','rotulo','rótulo']);
    const iSub =idx(['subtitle','subtitulo','subtítulo']);
    const iUrl =idx(['url','link','doc','arquivo']);
    const iOrd =idx(['order','ordem','pos']);
    const iEn  =idx(['enabled','ativo','publicado']);

    let list = rows.filter(r=> norm(r[iSlug])===norm(PAGE_SLUG) && (iEn<0 || String(r[iEn]||'1').trim()!=='0'));

    const todayRows = list.filter(r=>{
      if(iDate<0) return false;
      const isoRow = toISOfromCSV((r[iDate]||'').trim());
      return isoRow === iso;
    });
    list = todayRows.length ? todayRows : list.filter(r=> iDate<0 || (r[iDate]||'').trim()==='');

    const map = {};
    list.forEach(r=>{
      const key = keyAlias(iKey>=0 ? r[iKey] : '');
      const url = (r[iUrl]||'').trim();
      const label = (r[iLab]||'').trim();
      const sub = iSub>=0 ? (r[iSub]||'').trim() : '';
      const ord = iOrd>=0 ? Number(r[iOrd]||0) : 0;
      if(!map[key] || ord < map[key].ord){
        map[key] = {url,label,sub,ord};
      }
    });

    const btnCurta = document.getElementById('btn-curta');
    const btnLonga = document.getElementById('btn-longa');
    const btnHinos = document.getElementById('btn-hinos');

    setBtnState(btnCurta, map['versao-curta']?.url);
    setBtnState(btnLonga, map['versao-longa']?.url);
    setBtnState(btnHinos, map['hinos-melodias']?.url);

    if(map['versao-curta']?.label) btnCurta.querySelector('.main').textContent = map['versao-curta'].label;
    if(map['versao-curta']?.sub)   btnCurta.querySelector('.sub').textContent  = map['versao-curta'].sub;

    if(map['versao-longa']?.label) btnLonga.querySelector('.main').textContent = map['versao-longa'].label;
    if(map['versao-longa']?.sub)   btnLonga.querySelector('.sub').textContent  = map['versao-longa'].sub;

    if(map['hinos-melodias']?.label) btnHinos.querySelector('.main').textContent = map['hinos-melodias'].label;

    if(!map['versao-curta']?.url && !map['versao-longa']?.url && !map['hinos-melodias']?.url){
      toast('Nenhum link disponível para esta data.');
    }
  }catch(e){
    console.error(e);
    toast('Erro ao carregar planilha');
  }
})();
</script>
</body>
</html>


