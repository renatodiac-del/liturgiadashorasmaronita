<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Liturgia Eucarística do Dia</title>
<meta name="theme-color" content="#ffc0cb">
<style>
:root{
  --rosa:#ffe4eb; --navy:#0b2a4d;
  --ouro:#d6b25a; --ouro-velho:#b08a2e;
  --azul-del-rey:#003399;
  --shadow:rgba(0,0,0,.16); --fonte: Arial, Helvetica, sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:var(--fonte); background:var(--rosa); color:var(--navy);
  background-image:
    repeating-linear-gradient(45deg, rgba(11,42,77,.12) 0, rgba(11,42,77,.12) 2px, transparent 2px, transparent 40px),
    repeating-linear-gradient(-45deg, rgba(11,42,77,.12) 0, rgba(11,42,77,.12) 2px, transparent 2px, transparent 40px);
  background-size:40px 40px; display:flex; flex-direction:column; min-height:100vh;
}

/* HEADER */
header{text-align:center;padding:16px 12px 8px}
.title{
  color:var(--navy);
  font-size:calc(1.6rem + 2pt);
  font-weight:900;
  -webkit-text-stroke:1px var(--ouro-velho);
  text-shadow:
    -1px -1px 0 var(--ouro-velho),
     1px -1px 0 var(--ouro-velho),
    -1px  1px 0 var(--ouro-velho),
     1px  1px 0 var(--ouro-velho);
}

/* CONTAINER */
.wrap{max-width:640px;margin:0 auto;padding:10px 16px 28px;width:100%}

/* ÍCONE */
.hero{
  display:block;margin:10px auto 18px;max-width:100%;height:auto;max-height:420px;
  border:6px solid var(--ouro); box-shadow:0 0 0 4px var(--navy) inset,0 8px 18px var(--shadow);
  border-radius:14px
}

/* BLOCO CENTRAL */
.centerbox{display:flex;flex-direction:column;align-items:center;gap:12px}

/* Faixa da data (botão) */
.date{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:9px 18px;
  border-radius:16px; min-width:240px;
  background:#fff; color:var(--navy); font-size:1.15rem; font-weight:900;
  border:3px solid var(--azul-del-rey);
  box-shadow:
    inset 0 0 0 3px var(--ouro),
    0 3px 8px var(--shadow);
  cursor:pointer; user-select:none; outline:none;
  transition:background-color .2s, transform .12s, box-shadow .2s, opacity .2s;
}
.date:hover{background:#fff9f2; transform:scale(1.02)}
.date[aria-disabled="true"]{opacity:.55; cursor:not-allowed}

/* rótulo extra (se existir na planilha) */
.extra{
  display:block; margin-top:2px; font-size:.92rem; font-weight:700; color:#27466a;
}

/* Navegação (abaixo da faixa de data) */
.navrow{
  display:flex; align-items:center; justify-content:center; gap:14px;
}
.navbtn{
  appearance:none; background:#fff; cursor:pointer;
  padding:9px 14px; border-radius:12px; font-weight:900;
  border:3px solid var(--azul-del-rey);
  box-shadow:
    inset 0 0 0 3px var(--ouro),
    0 2px 6px var(--shadow);
  color:var(--navy);
  transition:background-color .2s, transform .12s, box-shadow .2s;
}
.navbtn:hover{background:#fffaf2; transform:translateY(-1px)}
.navbtn:focus-visible{
  outline:none;
  box-shadow:
    inset 0 0 0 3px var(--ouro),
    0 0 0 3px rgba(0,51,153,.35),
    0 2px 6px var(--shadow);
}

/* Botão Voltar (padrão do projeto) */
.back-wrap{
  display:flex; justify-content:center; margin-top:14px;
  transform:scale(.48); transform-origin:center top;
}
.btn-back{
  display:inline-flex; align-items:center; gap:10px;
  background:#a00000; color:#fff; border:none; border-radius:999px;
  padding:10px 16px; font-weight:800; cursor:pointer;
  box-shadow:0 6px 14px var(--shadow);
}
.btn-back .arr{font-size:18px; line-height:1}
</style>
</head>
<body>
<header><h1 class="title">Liturgia Eucarística do Dia</h1></header>

<main class="wrap">
  <img class="hero" src="img/icone-liturgiadia.jpg" alt="Ícone — Liturgia do Dia">

  <section class="centerbox" aria-label="Navegação e acesso">
    <!-- Faixa da data (botão) -->
    <div id="date" class="date" role="button" tabindex="0" aria-disabled="true">
      --/--/----<br><small>-</small><span class="extra" id="extra" hidden></span>
    </div>

    <!-- Setas de navegação -->
    <div class="navrow">
      <button id="prev" class="navbtn" type="button" aria-label="Dia anterior">← Anterior</button>
      <button id="next" class="navbtn" type="button" aria-label="Próximo dia">Próximo →</button>
    </div>

    <!-- Botão Voltar (no padrão do site) -->
    <div class="back-wrap">
      <button class="btn-back" type="button" onclick="goBackOrHome()">
        <span class="arr">←</span><span>Voltar</span>
      </button>
    </div>
  </section>
</main>

<script>
/* ====== CONFIG: Link CSV publicado da aba `qurbono-dia`
   Espera cabeçalho com DATA no formato DD/MM/AAAA.
   Colunas aceitas (mínimo): data (ou data_br), link_doc, ativo
   Opcionais: rotulo, obs
====== */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=136028404&single=true&output=csv';

/* ====== Utilitários ====== */
function goBackOrHome(){
  try{
    if(history.length>1) history.back();
    else location.href='index-teste.html';
  }catch(e){
    location.href='index-teste.html';
  }
}
function pad2(n){return String(n).padStart(2,'0');}
function toISODateLocal(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate());
  return `${y}-${m}-${day}`;
}
function fmtDateBR(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
function fmtWeekdayBR(d){
  const wd = d.toLocaleDateString('pt-BR',{weekday:'long'});
  return wd.charAt(0).toUpperCase()+wd.slice(1);
}

/* Converte "DD/MM/AAAA" -> "AAAA-MM-DD" */
function brToISO(br){
  const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec((br||'').trim());
  if(!m) return null;
  const [_, dd, mm, yyyy] = m;
  return `${yyyy}-${mm}-${dd}`;
}

function parseCSV(text){
  const rows=[]; let i=0, cur='', inQ=false;
  const push=()=>{(rows.at(-1)??rows.push([]),rows.at(-1)).push(cur); cur='';};
  rows.push([]);
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){ cur+='"'; i+=2; continue; }
      if(c==='"'){ inQ=false; i++; continue; }
      cur+=c; i++; continue;
    }else{
      if(c==='\"'){ inQ=true; i++; continue; }
      if(c===','){ push(); i++; continue; }
      if(c==='\r'){ i++; continue; }
      if(c==='\n'){ push(); rows.push([]); i++; continue; }
      cur+=c; i++; continue;
    }
  }
  (rows.at(-1)||rows.push([])).length || rows.pop();
  return rows;
}

/* ====== Estado e elementos ====== */
let current = new Date();
const dateEl  = document.getElementById('date');
const extraEl = document.getElementById('extra');
const prevBt  = document.getElementById('prev');
const nextBt  = document.getElementById('next');

const DATA_MAP = new Map(); // key: ISO -> {rotulo, link_doc, ativo}

/* ====== Renderização ====== */
function render(){
  const br = fmtDateBR(current);
  const wd = fmtWeekdayBR(current);
  const iso = toISODateLocal(current);

  const rec = DATA_MAP.get(iso);
  const has = !!(rec && rec.link_doc && String(rec.ativo)==='1');

  // conteúdo visual
  dateEl.innerHTML = `${br}<br><small>${wd}</small>`;
  const rot = rec && rec.rotulo ? rec.rotulo.trim() : '';
  if(rot){
    extraEl.hidden = false;
    extraEl.textContent = rot;
    dateEl.appendChild(extraEl);
  }else{
    extraEl.hidden = true;
    extraEl.textContent = '';
  }

  // acessibilidade / clique
  if(has){
    dateEl.removeAttribute('aria-disabled');
    dateEl.title = 'Abrir a liturgia deste dia';
    dateEl.style.pointerEvents = 'auto';
    dateEl.style.opacity = '1';
  }else{
    dateEl.setAttribute('aria-disabled','true');
    dateEl.title = 'Sem link configurado para este dia';
    dateEl.style.pointerEvents = 'none';
    dateEl.style.opacity = '.55';
  }
}

/* ====== Navegação ====== */
prevBt.addEventListener('click', ()=>{ current.setDate(current.getDate()-1); render(); });
nextBt.addEventListener('click', ()=>{ current.setDate(current.getDate()+1); render(); });

dateEl.addEventListener('click', ()=>{
  if(dateEl.getAttribute('aria-disabled')==='true') return;
  const iso = toISODateLocal(current);
  const rec = DATA_MAP.get(iso);
  if(rec && rec.link_doc) window.open(rec.link_doc,'_blank','noopener');
});
dateEl.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' || e.key===' '){
    e.preventDefault();
    dateEl.click();
  }
});

/* ====== Carregar CSV (DATA EM DD/MM/AAAA) ====== */
fetch(CSV_URL)
  .then(r=>r.text())
  .then(txt=>{
    const rows = parseCSV(txt).filter(r=>r.length && r.some(c=>c.trim()!==''));
    if(!rows.length) throw new Error('CSV vazio');

    // cabeçalho (aceita "data" ou "data_br" para DD/MM/AAAA; mantém compat. com "data_iso")
    const header = rows[0].map(h=>h.trim().toLowerCase());
    const col = {
      data_br:  (header.indexOf('data')>-1 ? header.indexOf('data') : header.indexOf('data_br')),
      data_iso: header.indexOf('data_iso'),
      rotulo:   header.indexOf('rotulo'),
      link:     header.indexOf('link_doc'),
      ativo:    header.indexOf('ativo'),
      obs:      header.indexOf('obs')
    };
    if(col.link<0 || col.ativo<0 || (col.data_br<0 && col.data_iso<0)){
      throw new Error('Cabeçalho esperado: data (DD/MM/AAAA) ou data_br, link_doc, ativo (rotulo e obs opcionais)');
    }

    for(let i=1;i<rows.length;i++){
      const r=rows[i];

      // Se vier data BR, converte para ISO; senão usa data_iso como está.
      let iso = null;
      if(col.data_br>=0){
        const br = (r[col.data_br]||'').trim();
        iso = brToISO(br);
      }else if(col.data_iso>=0){
        const raw = (r[col.data_iso]||'').trim();
        iso = /^\d{4}-\d{2}-\d{2}$/.test(raw) ? raw : null;
      }
      if(!iso) continue;

      const rotulo =(col.rotulo>=0? (r[col.rotulo]||'').trim() : '');
      const link   =(r[col.link]||'').trim();
      const ativo  = String((r[col.ativo]||'').trim());
      DATA_MAP.set(iso,{rotulo, link_doc:link, ativo});
    }
    render();
  })
  .catch(err=>{
    console.error('Falha ao carregar CSV:', err);
    render();
  });
</script>
</body>
</html>
