<!-- patristica.html ‚Äî corrige "linha colada" no author_name e trata √≠cone absoluto/relativo -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Patr√≠stica Sir√≠aca</title>
<style>
:root{--areia-clara:#efe1c7;--areia-media:#e6d6b4;--areia-escura:#c2a772;--ouro:#b4923a;--preto:#111;--shadow:rgba(0,0,0,.18);--sans:Arial,Helvetica,sans-serif;--vermelho:#a00000;}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:var(--sans);color:#2b2114;
  background:
    radial-gradient(1px 1px at 15% 25%,rgba(255,255,255,.8),transparent 60%),
    radial-gradient(1px 1px at 75% 12%,rgba(255,255,255,.75),transparent 60%),
    radial-gradient(1px 1px at 55% 70%,rgba(255,255,255,.7),transparent 60%),
    radial-gradient(1px 1px at 28% 58%,rgba(255,255,255,.8),transparent 60%),
    linear-gradient(to top,var(--areia-escura),var(--areia-media),var(--areia-clara));
  display:flex;flex-direction:column;min-height:100vh
}
.wrap{max-width:640px;margin:0 auto;padding:12px 16px 22px;width:100%}
.title{
  text-align:center;font-size:calc(1.9rem + 3pt);font-weight:900;color:var(--preto);
  text-shadow:-1px -1px 0 var(--ouro),1px -1px 0 var(--ouro),-1px 1px 0 var(--ouro),1px 1px 0 var(--ouro);
  margin-bottom:8px
}
.hero{
  display:block;margin:8px auto 16px;max-width:100%;width:100%;height:260px;object-fit:contain;
  border:6px solid var(--ouro);border-radius:40% / 18%;
  box-shadow:0 8px 18px var(--shadow);background:#fff7e6
}
.centerbox{display:flex;flex-direction:column;align-items:center;gap:14px}
.nameBtn{
  display:flex;align-items:center;justify-content:center;text-align:center;
  padding:12px 20px;min-width:260px;border-radius:16px;background:#fff;color:#2b2114;
  font-weight:900;font-size:calc(1.15rem + 2pt);cursor:pointer;user-select:none;
  border:3px solid var(--ouro);box-shadow:inset 0 0 0 3px rgba(180,146,58,.55),0 3px 8px var(--shadow);
  transition:transform .12s,background-color .2s
}
.nameBtn:hover{transform:scale(1.02);background:#fffdf4}
.navrow{display:flex;justify-content:center;gap:14px;margin-top:10px}
.navbtn{
  background:#fff;color:#2b2114;font-weight:900;padding:9px 14px;border-radius:12px;cursor:pointer;
  border:3px solid var(--ouro);box-shadow:inset 0 0 0 3px rgba(180,146,58,.5),0 2px 6px var(--shadow);
  transition:background-color .2s,transform .12s
}
.navbtn:hover{background:#fffdf1;transform:translateY(-1px)}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;width:100%}
.actionBtn{
  display:flex;align-items:center;justify-content:center;text-align:center;min-height:64px;
  padding:12px;border-radius:14px;text-decoration:none;background:#fff;color:#2b2114;font-weight:800;
  border:3px solid var(--ouro);box-shadow:inset 0 0 0 3px rgba(180,146,58,.45),0 3px 8px var(--shadow)
}
.actionBtn[aria-disabled="true"]{opacity:.45;pointer-events:none}
.alert{margin:10px auto;width:90%;max-width:520px;background:#fff3cd;color:#7c5b00;border:1px solid #ffe08a;padding:6px 10px;font-size:.9rem;border-radius:8px;text-align:center;display:none}
footer{margin-top:auto;padding:16px 0 36px;text-align:center}
.voltar{
  background:var(--vermelho);color:#fff;font-size:.65rem;font-weight:bold;border:none;border-radius:6px;
  padding:.3rem .55rem;cursor:pointer;display:inline-flex;align-items:center;gap:.4rem;text-decoration:none;
  transform:scale(0.6);transform-origin:center
}
.voltar:hover{background:#c00000}

/* Painel Debug */
.debug-toggle{margin:10px auto 0;max-width:640px;width:100%;display:flex;justify-content:center}
.debug-btn{font-size:.8rem;border:2px dashed #b97a00;background:#fff7e0;color:#7a5200;border-radius:8px;padding:.3rem .6rem;cursor:pointer}
.debug{display:none;margin:10px auto 0;max-width:640px;width:100%;background:#fffef7;border:1px solid #ffe3a6;border-radius:10px;padding:10px 12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.85rem;line-height:1.35}
.debug table{width:100%;border-collapse:collapse}
.debug td,.debug th{border-bottom:1px dotted #f0d58a;padding:6px 4px;vertical-align:top}
.debug th{text-align:left;color:#6a4b00}
.ok{color:#116611} .warn{color:#995500} .bad{color:#aa0000}
</style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">Patr√≠stica Sir√≠aca</h1>
    <img id="hero" class="hero" src="img/icone-patristica.png" alt="Patr√≠stica Sir√≠aca" onerror="this.src='img/icone-patristica.png';this.onerror=null;">
    <div id="alert" class="alert"></div>

    <section class="centerbox" aria-label="Autores">
      <button id="nameBtn" class="nameBtn" type="button">‚Äî</button>
      <div class="navrow">
        <button id="prev" class="navbtn" type="button">‚Üê Anterior</button>
        <button id="next" class="navbtn" type="button">Pr√≥ximo ‚Üí</button>
      </div>
    </section>

    <section id="actions" class="actions" aria-label="Links do autor"></section>

    <div class="debug-toggle">
      <button id="dbgBtn" class="debug-btn" type="button">üîé Debug</button>
    </div>
    <div id="debug" class="debug" aria-live="polite"></div>
  </main>

  <footer>
    <a class="voltar" href="javascript:history.back()">&#8592; Voltar</a>
  </footer>

<script>
// =================== CONFIG ===================
var CSV_AUTHORS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=161703440&single=true&output=csv";
var CSV_LINKS   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=101845558&single=true&output=csv";

var BUTTON_ORDER = ['biografia','homilias','hinos','obras'];
var LABELS = { biografia:'Biografia', homilias:'Homilias', hinos:'Hinos', obras:'Obras selecionadas' };

// Fallback de √≠cones por slug
var ICON_BY_SLUG = {
  'santo-efrem':'efrem.png',
  'narsai-de-nisibis':'narsai-nisibis.png',
  'jaco-de-serugh':'jaco-serugh.png',
  'isaque-de-ninive':'isaque-ninive.jpeg'
};

// =================== UTILS ===================
function normHeader(h){
  if(!h) return '';
  var s = (''+h).toLowerCase();
  if(s.normalize){ s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  s = s.replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  if(s==='name'||s==='autor'||s==='author') s='author_name';
  if(s==='slug'||s==='autor_slug'||s==='authorslug') s='author_slug';
  return s;
}
function detectDelimiter(line){
  if(!line) return ',';
  var cand=[',',';','\t'], best=',', bestScore=-1;
  for(var i=0;i<cand.length;i++){
    var d=cand[i], count=0, q=false;
    for(var j=0;j<line.length;j++){
      var c=line[j];
      if(c=='"'){ if(q && line[j+1]=='"'){ j++; } else { q=!q; } }
      else if(c===d && !q){ count++; }
    }
    if(count>bestScore){ bestScore=count; best=d; }
  }
  return best;
}
function parseCSV(text){
  text = (text||'').replace(/^\uFEFF/, '').replace(/\u00A0/g,' ');
  var lines = text.split(/\r?\n/).filter(function(l){return l.trim()!==''});
  if(!lines.length) return [];
  var delim = detectDelimiter(lines[0]);
  var rows=[];
  for(var li=0; li<lines.length; li++){
    var line=lines[li], cur='', q=false, row=[];
    for(var i=0;i<line.length;i++){
      var c=line[i];
      if(c=='"'){
        if(q && line[i+1]=='"'){ cur+='"'; i++; } else { q=!q; }
      } else if(c===delim && !q){ row.push(cur); cur=''; }
      else { cur+=c; }
    }
    row.push(cur);
    rows.push(row.map(function(x){ return (x||'').trim(); }));
  }
  return rows;
}
function splitSmart(s){
  var d = detectDelimiter(s);
  return s.replace(/^"|"$|^'|'$/g,'').split(d).map(function(t){return t.trim();});
}
function expandCollapsed(arr){
  if(!arr || !arr.length) return arr;
  if(arr[0].length===1 && (arr[0][0].includes(',')||arr[0][0].includes('\t')||arr[0][0].includes(';'))){
    arr[0] = splitSmart(arr[0][0]);
  }
  for(var r=1;r<arr.length;r++){
    if(arr[r].length===1 && (arr[r][0].includes(',')||arr[r][0].includes('\t')||arr[r][0].includes(';'))){
      arr[r] = splitSmart(arr[r][0]);
    }
  }
  return arr;
}

function fetchCSV(url){
  var real=url + (url.indexOf('?')>-1?'&':'?') + 't=' + Date.now();
  return fetch(real, {cache:'no-store'})
    .then(function(res){ if(!res.ok) throw new Error('CSV '+res.status); return res.text(); })
    .then(function(txt){
      var arr = expandCollapsed(parseCSV(txt));
      var head = arr.length? arr[0] : [];
      var rows = arr.length>1? arr.slice(1) : [];
      return {head:head, rows:rows};
    });
}
function slugify(s){
  s = s||'';
  if(s.normalize){ s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
}
function stripQuotes(s){
  return (s||'').replace(/^\\s*['"]|['"]\\s*$/g,'').trim();
}

// =================== ESTADO / REFS ===================
var autores=[], linksMap={}, idx=0;
var hero=document.getElementById('hero');
var alertBx=document.getElementById('alert');
var nameBtn=document.getElementById('nameBtn');
var prevBt=document.getElementById('prev');
var nextBt=document.getElementById('next');
var actions=document.getElementById('actions');
var dbgBtn=document.getElementById('dbgBtn');
var dbgBox=document.getElementById('debug');

// =================== BUILDERS ===================
// Constr√≥i autores a partir da "tabela" e corrige quando author_name vem com tudo colado.
function buildAuthors(head, rows){
  var map={}; for(var i=0;i<head.length;i++) map[normHeader(head[i])]=i;
  var out=[];
  for(var i=0;i<rows.length;i++){
    var r = rows[i].slice(); // clone
    // Se n√£o h√° author_slug no cabe√ßalho, mas author_name contem v√≠rgulas => desmonta
    var hasSlugCol = map.author_slug!=null;
    var nmRaw = (r[map.author_name]!=null ? r[map.author_name] : '').trim();
    if(nmRaw && (!hasSlugCol || !r[map.author_slug]) && nmRaw.indexOf(',')>-1){
      var parts = nmRaw.split(',').map(function(x){return stripQuotes(x);});
      r[map.author_name] = parts[0] || '';
      // injeta colunas faltantes
      if(map.author_slug==null){ map.author_slug = head.push('author_slug')-1; }
      if(map.order==null){ map.order = head.push('order')-1; }
      if(map.enabled==null){ map.enabled = head.push('enabled')-1; }
      if(map.icon==null){ map.icon = head.push('icon')-1; }
      r[map.author_slug] = parts[1] || r[map.author_slug] || '';
      r[map.order]       = parts[2] || r[map.order] || '';
      r[map.enabled]     = parts[3] || r[map.enabled] || '1';
      r[map.icon]        = parts.slice(4).join(',').trim() || r[map.icon] || '';
    }

    var nm=(r[map.author_name]||'').trim(); if(!nm) continue;
    var en=(map.enabled!=null? String(r[map.enabled]||'').trim():'1'); if(en!=='1') continue;
    var sl=(map.author_slug!=null? (r[map.author_slug]||'').trim() : ''); if(!sl) sl=slugify(nm);
    var ic=(map.icon!=null? stripQuotes(r[map.icon]||'') : '');
    out.push({author_name:nm,author_slug:sl,icon:ic});
  }
  return out;
}
function buildLinks(head, rows){
  var map={}; for(var i=0;i<head.length;i++) map[normHeader(head[i])]=i;
  var out={};
  for(var i=0;i<rows.length;i++){
    var r=rows[i];
    var as=(r[map.author_slug]||'').trim(); if(!as) continue;
    var key=((r[map.button_key]||'')+'').trim().toLowerCase(); if(!key) continue;
    (out[as]||(out[as]={}))[key]={
      label:(map.label!=null?(r[map.label]||''):'').trim()||LABELS[key]||key,
      url:(map.url!=null?(r[map.url]||''):'').trim(),
      enabled:String(map.enabled!=null?(r[map.enabled]||'1'):'1').trim()
    };
  }
  return out;
}

// =================== RENDER ===================
function resolveIconPath(icon, slug){
  var file = stripQuotes(icon||'');
  if(!file){ file = ICON_BY_SLUG[slug] || 'icone-patristica.png'; }
  // Se come√ßa com http(s) ou "/", usa como est√°. Caso contr√°rio, prefixa "img/"
  if(/^https?:\\/\\//i.test(file) || file.startsWith('/')) return file;
  return 'img/' + file;
}
function updateHero(a){
  hero.alt = a.author_name || 'Patr√≠stica Sir√≠aca';
  hero.src = resolveIconPath(a.icon, a.author_slug);
}
function renderDebug(a, byAuthor){
  function esc(x){return (x||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');}
  var rows = BUTTON_ORDER.map(function(k){
    var d = byAuthor[k] || {};
    var ok = (!!d.url) && (String(d.enabled).trim()==='1');
    var reason = ok ? 'ok' :
      (!d.url ? 'sem url' : (String(d.enabled).trim()!=='1' ? 'enabled ‚â† 1' : 'desconhecido'));
    return '<tr><th>'+k+'</th><td>'+ esc(d.label||'') +'</td><td>'+ esc(d.enabled||'') +'</td><td>'+ esc(d.url||'') +
           '</td><td class="'+(ok?'ok': 'bad')+'">'+ (ok?'ligado':'OFF ‚Äî '+reason) +'</td></tr>';
  }).join('');
  dbgBox.innerHTML =
    '<table>'+
    '<tr><th style="width:120px">author_name</th><td>'+ esc(a.author_name||'') +'</td></tr>'+
    '<tr><th>author_slug</th><td>'+ esc(a.author_slug||'') +'</td></tr>'+
    '<tr><th>icon (resolvido)</th><td>'+ esc(resolveIconPath(a.icon, a.author_slug)) +'</td></tr>'+
    '<tr><th colspan="2">‚Äî</th></tr>'+
    '<tr><th>button_key</th><th>label</th><th>enabled</th><th>url</th><th>status</th></tr>'+
    rows+
    '</table>';
}
function render(){
  if(!autores.length){
    nameBtn.textContent='‚Äî';
    actions.innerHTML='';
    prevBt.disabled = true; nextBt.disabled = true;
    return;
  }
  prevBt.disabled = false; nextBt.disabled = false;

  var a = autores[idx];
  nameBtn.textContent = a.author_name || '‚Äî';
  updateHero(a);

  actions.innerHTML='';
  var byAuthor = linksMap[a.author_slug] || {};
  BUTTON_ORDER.forEach(function(key){
    var d = byAuthor[key] || {label:LABELS[key], url:'', enabled:'0'};
    var A = document.createElement('a');
    A.className = 'actionBtn';
    A.textContent = d.label || LABELS[key] || key;
    A.title = (d.url||'(sem url)') + ' ‚Äî enabled=' + (d.enabled||'');
    var on = d.url && String(d.enabled).trim()==='1';
    if(on){ A.href=d.url; A.target='_blank'; A.rel='noopener'; }
    else { A.href='#'; A.setAttribute('aria-disabled','true'); }
    actions.appendChild(A);
  });

  if(dbgBox.style.display==='block'){ renderDebug(a, byAuthor); }
}

// =================== EVENTOS ===================
function openPrimary(){
  if(!autores.length) return;
  var a = autores[idx];
  var byAuthor = linksMap[a.author_slug] || {};
  for(var bi=0; bi<BUTTON_ORDER.length; bi++){
    var k = BUTTON_ORDER[bi];
    var d = byAuthor[k];
    if(d && d.url && String(d.enabled).trim()==='1'){ window.open(d.url,'_blank'); return; }
  }
  location.hash = a.author_slug || '#';
}
nameBtn.addEventListener('click', openPrimary);
prevBt.addEventListener('click', function(){ if(!autores.length) return; idx=(idx-1+autores.length)%autores.length; render(); });
nextBt.addEventListener('click', function(){ if(!autores.length) return; idx=(idx+1)%autores.length; render(); });
dbgBtn.addEventListener('click', function(){
  dbgBox.style.display = (dbgBox.style.display==='block' ? 'none' : 'block');
  render();
});

// =================== BOOT ===================
(function init(){
  Promise.all([fetchCSV(CSV_AUTHORS), fetchCSV(CSV_LINKS)])
    .then(function(all){
      var A = all[0], L = all[1];

      // ------- Autores (tabela + corre√ß√£o de "linha colada") -------
      autores = buildAuthors(A.head.slice(), A.rows) || [];
      if(!autores.length) throw new Error('Sem autores v√°lidos (confira a aba patristica-autores).');

      // ------- Links (tabela) -------
      linksMap = buildLinks(L.head, L.rows) || {};

      // Autor inicial via hash
      var h = (location.hash||'').replace(/^#/,'');
      var pos = -1;
      for(var k=0;k<autores.length;k++){ if(autores[k].author_slug===h){ pos=k; break; } }
      idx = pos>=0 ? pos : 0;

      if(alertBx) alertBx.style.display='none';
      render();
    })
    .catch(function(err){
      console.warn('[Patr√≠stica] Falha ao carregar CSV. Usando fallback. Motivo:', err);
      if(alertBx){ alertBx.textContent='N√£o foi poss√≠vel carregar a planilha. Usando lista local provis√≥ria.'; alertBx.style.display='block'; }
      autores=[
        {author_name:'Santo Efr√©m',author_slug:'santo-efrem',icon:'efrem.png'},
        {author_name:'Narsai de Nisibis',author_slug:'narsai-de-nisibis',icon:'narsai-nisibis.png'},
        {author_name:'Jac√≥ de Serugh',author_slug:'jaco-de-serugh',icon:'jaco-serugh.png'},
        {author_name:'Isaque de N√≠nive',author_slug:'isaque-de-ninive',icon:'isaque-ninive.jpeg'}
      ];
      linksMap={}; idx=0; render();
    });
})();
</script>
</body>
</html>



