
<!-- patristica.html — super defensivo: autodetecta delimitador, descola linhas, aceita dados sem cabeçalho -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Patrística Siríaca</title>
<style>
:root{--areia-clara:#efe1c7;--areia-media:#e6d6b4;--areia-escura:#c2a772;--ouro:#b4923a;--preto:#111;--shadow:rgba(0,0,0,.18);--sans:Arial,Helvetica,sans-serif;--vermelho:#a00000;}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:var(--sans);color:#2b2114;
  background:
    radial-gradient(1px 1px at 15% 25%,rgba(255,255,255,.8),transparent 60%),
    radial-gradient(1px 1px at 75% 12%,rgba(255,255,255,.75),transparent 60%),
    radial-gradient(1px 1px at 55% 70%,rgba(255,255,255,.7),transparent 60%),
    radial-gradient(1px 1px at 28% 58%,rgba(255,255,255,.8),transparent 60%),
    linear-gradient(to top,var(--areia-escura),var(--areia-media),var(--areia-clara));
  display:flex;flex-direction:column;min-height:100vh
}
.wrap{max-width:640px;margin:0 auto;padding:12px 16px 22px;width:100%}
.title{
  text-align:center;font-size:calc(1.9rem + 3pt);font-weight:900;color:var(--preto);
  text-shadow:-1px -1px 0 var(--ouro),1px -1px 0 var(--ouro),-1px 1px 0 var(--ouro),1px 1px 0 var(--ouro);
  margin-bottom:8px
}
.hero{
  display:block;margin:8px auto 16px;max-width:100%;width:100%;height:260px;object-fit:contain;
  border:6px solid var(--ouro);border-radius:40% / 18%;
  box-shadow:0 8px 18px var(--shadow);background:#fff7e6
}
.centerbox{display:flex;flex-direction:column;align-items:center;gap:14px}
.nameBtn{
  display:flex;align-items:center;justify-content:center;text-align:center;
  padding:12px 20px;min-width:260px;border-radius:16px;background:#fff;color:#2b2114;
  font-weight:900;font-size:calc(1.15rem + 2pt);cursor:pointer;user-select:none;
  border:3px solid var(--ouro);box-shadow:inset 0 0 0 3px rgba(180,146,58,.55),0 3px 8px var(--shadow);
  transition:transform .12s,background-color .2s
}
.nameBtn:hover{transform:scale(1.02);background:#fffdf4}
.navrow{display:flex;justify-content:center;gap:14px;margin-top:10px}
.navbtn{
  background:#fff;color:#2b2114;font-weight:900;padding:9px 14px;border-radius:12px;cursor:pointer;
  border:3px solid var(--ouro);box-shadow:inset 0 0 0 3px rgba(180,146,58,.5),0 2px 6px var(--shadow);
  transition:background-color .2s,transform .12s
}
.navbtn:hover{background:#fffdf1;transform:translateY(-1px)}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;width:100%}
.actionBtn{
  display:flex;align-items:center;justify-content:center;text-align:center;min-height:64px;
  padding:12px;border-radius:14px;text-decoration:none;background:#fff;color:#2b2114;font-weight:800;
  border:3px solid var(--ouro);box-shadow:inset 0 0 0 3px rgba(180,146,58,.45),0 3px 8px var(--shadow)
}
.actionBtn[aria-disabled="true"]{opacity:.45;pointer-events:none}
.alert{margin:10px auto;width:90%;max-width:520px;background:#fff3cd;color:#7c5b00;border:1px solid #ffe08a;padding:6px 10px;font-size:.9rem;border-radius:8px;text-align:center;display:none}
footer{margin-top:auto;padding:16px 0 36px;text-align:center}
.voltar{
  background:var(--vermelho);color:#fff;font-size:.65rem;font-weight:bold;border:none;border-radius:6px;
  padding:.3rem .55rem;cursor:pointer;display:inline-flex;align-items:center;gap:.4rem;text-decoration:none;
  transform:scale(0.6);transform-origin:center
}
.voltar:hover{background:#c00000}
</style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">Patrística Siríaca</h1>
    <img id="hero" class="hero" src="img/icone-patristica.png" alt="Patrística Siríaca" onerror="this.src='img/icone-patristica.png';this.onerror=null;">
    <div id="alert" class="alert"></div>

    <section class="centerbox" aria-label="Autores">
      <button id="nameBtn" class="nameBtn" type="button">—</button>
      <div class="navrow">
        <button id="prev" class="navbtn" type="button">← Anterior</button>
        <button id="next" class="navbtn" type="button">Próximo →</button>
      </div>
    </section>

    <section id="actions" class="actions" aria-label="Links do autor"></section>
  </main>

  <footer>
    <a class="voltar" href="javascript:history.back()">&#8592; Voltar</a>
  </footer>

<script>
// =================== CONFIG ===================
var CSV_AUTHORS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=161703440&single=true&output=csv";
var CSV_LINKS   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=101845558&single=true&output=csv";

var BUTTON_ORDER = ['biografia','homilias','hinos','obras'];
var LABELS = { biografia:'Biografia', homilias:'Homilias', hinos:'Hinos', obras:'Obras selecionadas' };

// Fallback de ícones por slug (usados se a planilha não trouxer `icon`)
var ICON_BY_SLUG = {
  'santo-efrem':'efrem.png',
  'narsai-de-nisibis':'narsai-nisibis.png',
  'jaco-de-serugh':'jaco-serugh.png',
  'isaque-de-ninive':'isaque-ninive.jpeg'
};

// =================== UTILS ===================
// normaliza cabeçalho (remove acentos e espaços)
function normHeader(h){
  if(!h) return '';
  var s = (''+h).toLowerCase();
  if(s.normalize){ s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  s = s.replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  if(s==='name'||s==='autor'||s==='author') s='author_name';
  if(s==='slug'||s==='autor_slug'||s==='authorslug') s='author_slug';
  return s;
}

// detecta o melhor delimitador (vírgula, ponto-e-vírgula ou tab)
function detectDelimiter(line){
  if(!line) return ',';
  var cand=[',',';','\t'];
  var best=',', bestScore=-1;
  for(var i=0;i<cand.length;i++){
    var d=cand[i], count=0, q=false;
    for(var j=0;j<line.length;j++){
      var c=line[j];
      if(c=='"'){ if(q && line[j+1]=='"'){ j++; } else { q=!q; } }
      else if(c===d && !q){ count++; }
    }
    if(count>bestScore){ bestScore=count; best=d; }
  }
  return best;
}

// parser genérico (aspas, delimitador detectado, remove BOM)
function parseCSV(text){
  text = (text||'').replace(/^\uFEFF/, '');
  var lines = text.split(/\r?\n/).filter(function(l){return l.trim()!==''});
  if(!lines.length) return [];
  var delim = detectDelimiter(lines[0]);
  var rows=[];
  for(var li=0; li<lines.length; li++){
    var line=lines[li], cur='', q=false, row=[];
    for(var i=0;i<line.length;i++){
      var c=line[i];
      if(c=='"'){
        if(q && line[i+1]=='"'){ cur+='"'; i++; } else { q=!q; }
      } else if(c===delim && !q){ row.push(cur); cur=''; }
      else { cur+=c; }
    }
    row.push(cur);
    rows.push(row.map(function(x){ return (x||'').trim(); }));
  }
  return rows;
}

// descola cabeçalho/linhas se vierem em 1 célula
function expandCollapsed(arr){
  if(!arr || !arr.length) return arr;
  function smartSplit(s){
    // tenta detectar delimitador e dividir
    var d = detectDelimiter(s);
    return s.replace(/^"|"$|^'|'$/g,'').split(d).map(function(t){return t.trim();});
  }
  if(arr[0].length===1 && arr[0][0].indexOf(',')>-1 || arr[0].length===1 && arr[0][0].indexOf('\t')>-1 || arr[0].length===1 && arr[0][0].indexOf(';')>-1){
    arr[0] = smartSplit(arr[0][0]);
  }
  for(var r=1;r<arr.length;r++){
    if(arr[r].length===1 && (arr[r][0].indexOf(',')>-1 || arr[r][0].indexOf('\t')>-1 || arr[r][0].indexOf(';')>-1)){
      arr[r] = smartSplit(arr[r][0]);
    }
  }
  return arr;
}

function fetchCSV(url){
  return fetch(url + (url.indexOf('?')>-1?'&':'?') + 't=' + Date.now(), {cache:'no-store'})
    .then(function(res){ if(!res.ok) throw new Error('CSV '+res.status); return res.text(); })
    .then(function(txt){
      var arr = expandCollapsed(parseCSV(txt));
      var head = arr.length? arr[0] : [];
      var rows = arr.length>1? arr.slice(1) : [];
      // Se a "linha 1" parece dados (ex.: começa com "Santo " e não tem author_name), assume ordem padrão
      var hasHeader = head.some(function(h){ return normHeader(h)==='author_name'; });
      var map = {};
      if(hasHeader){
        for(var i=0;i<head.length;i++){ map[normHeader(head[i])] = i; }
      }else{
        // ordem padrão: author_name, author_slug, order, enabled, icon
        map = { author_name:0, author_slug:1, order:2, enabled:3, icon:4 };
        // Insere de volta a "head" como primeira linha de dados, se for necessário
        if(head.length){ rows.unshift(head); }
      }
      return {rows:rows, map:map, head:head};
    });
}

function slugify(s){
  s = s||'';
  if(s.normalize){ s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
}

// =================== ESTADO / REFS ===================
var autores = [];            // [{author_name, author_slug, icon}]
var linksMap = {};           // { slug: { key: {label,url,enabled} } }
var idx = 0;
var hero    = document.getElementById('hero');
var alertBx = document.getElementById('alert');
var nameBtn = document.getElementById('nameBtn');
var prevBt  = document.getElementById('prev');
var nextBt  = document.getElementById('next');
var actions = document.getElementById('actions');

// =================== RENDER ===================
function updateHero(a){
  var file = (a.icon && a.icon.trim()) || ICON_BY_SLUG[a.author_slug] || 'icone-patristica.png';
  hero.alt = a.author_name || 'Patrística Siríaca';
  hero.src = 'img/' + file;
}

function render(){
  if(!autores.length){
    nameBtn.textContent='—';
    actions.innerHTML='';
    prevBt.disabled = true; nextBt.disabled = true;
    return;
  }
  prevBt.disabled = false; nextBt.disabled = false;

  var a = autores[idx];
  nameBtn.textContent = a.author_name || '—';
  updateHero(a);

  actions.innerHTML='';
  var byAuthor = linksMap[a.author_slug] || {};
  for(var bi=0; bi<BUTTON_ORDER.length; bi++){
    var key = BUTTON_ORDER[bi];
    var d = byAuthor[key] || {label:LABELS[key], url:'', enabled:'0'};
    var A = document.createElement('a');
    A.className = 'actionBtn';
    A.textContent = d.label || LABELS[key] || key;
    var on = d.url && String(d.enabled).trim()==='1';
    if(on){ A.href=d.url; A.target='_blank'; A.rel='noopener'; }
    else { A.href='#'; A.setAttribute('aria-disabled','true'); }
    actions.appendChild(A);
  }
}

function openPrimary(){
  if(!autores.length) return;
  var a = autores[idx];
  var byAuthor = linksMap[a.author_slug] || {};
  for(var bi=0; bi<BUTTON_ORDER.length; bi++){
    var k = BUTTON_ORDER[bi];
    var d = byAuthor[k];
    if(d && d.url && String(d.enabled).trim()==='1'){ window.open(d.url,'_blank'); return; }
  }
  location.hash = a.author_slug || '#';
}

// =================== EVENTOS ===================
nameBtn.addEventListener('click', openPrimary);
prevBt.addEventListener('click', function(){ if(!autores.length) return; idx=(idx-1+autores.length)%autores.length; render(); });
nextBt.addEventListener('click', function(){ if(!autores.length) return; idx=(idx+1)%autores.length; render(); });

// =================== BOOT ===================
(function init(){
  Promise.all([fetchCSV(CSV_AUTHORS), fetchCSV(CSV_LINKS)])
    .then(function(all){
      var A = all[0].map, rowsA = all[0].rows;
      var L = all[1].map, rowsL = all[1].rows;

      // Autores
      autores = [];
      for(var i=0;i<rowsA.length;i++){
        var r = rowsA[i];
        var nm = (r[A.author_name]||'').trim();
        if(!nm) continue;
        var en = (A.enabled!=null? String(r[A.enabled]||'').trim() : '1');
        if(en!=='1') continue;
        var sl = A.author_slug!=null ? (r[A.author_slug]||'').trim() : '';
        if(!sl) sl = slugify(nm);
        var ic = A.icon!=null ? (r[A.icon]||'').trim() : '';
        autores.push({author_name:nm, author_slug:sl, icon:ic});
      }
      if(!autores.length) throw new Error('Sem autores válidos (verifique cabeçalho/linhas e enabled=1).');

      // Links
      linksMap = {};
      if(L.author_slug!=null && L.button_key!=null){
        for(var j=0;j<rowsL.length;j++){
          var rL = rowsL[j];
          var as = (rL[L.author_slug]||'').trim(); if(!as) continue;
          var key = (rL[L.button_key]||'').trim().toLowerCase(); if(!key) continue;
          if(!linksMap[as]) linksMap[as] = {};
          linksMap[as][key] = {
            label: (L.label!=null ? (rL[L.label]||'') : '').trim() || LABELS[key] || key,
            url:   (L.url  !=null ? (rL[L.url  ]||'') : '').trim(),
            enabled: String(L.enabled!=null ? (rL[L.enabled]||'1') : '1').trim()
          };
        }
      }

      // Autor inicial via hash
      var h = (location.hash||'').replace(/^#/,'');
      var pos = -1;
      for(var k=0;k<autores.length;k++){ if(autores[k].author_slug===h){ pos=k; break; } }
      idx = pos>=0 ? pos : 0;

      if(alertBx) alertBx.style.display='none';
      render();
    })
    .catch(function(err){
      console.warn('[Patrística] Falha ao carregar CSV. Usando fallback. Motivo:', err);
      if(alertBx){ alertBx.textContent='Não foi possível carregar a planilha. Usando lista local provisória.'; alertBx.style.display='block'; }
      autores=[
        {author_name:'Santo Efrém',author_slug:'santo-efrem',icon:'efrem.png'},
        {author_name:'Narsai de Nisibis',author_slug:'narsai-de-nisibis',icon:'narsai-nisibis.png'},
        {author_name:'Jacó de Serugh',author_slug:'jaco-de-serugh',icon:'jaco-serugh.png'},
        {author_name:'Isaque de Nínive',author_slug:'isaque-de-ninive',icon:'isaque-ninive.jpeg'}
      ];
      linksMap={}; idx=0; render();
    });
})();
</script>
</body>
</html>
