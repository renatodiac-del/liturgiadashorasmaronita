<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="img/app-icon-180.png">
<link rel="icon" href="img/favicon-32.png" sizes="32x32">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>
  --bege:#cfbd95; --laranja:#ff7a00; --dourado:#d6b25a; --ouro-velho:#b08a2e;
  --escuro:#3a2d18; --sombra:rgba(0,0,0,.16); --vermelho:#a00000;
  --fonte: Arial, Helvetica, sans-serif;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;font-family:var(--fonte); color:var(--escuro); background:var(--bege);
  background-image:
    repeating-linear-gradient(45deg, rgba(255,122,0,.22) 0, rgba(255,122,0,.22) 2px, transparent 2px, transparent 40px),
    repeating-linear-gradient(-45deg, rgba(255,122,0,.22) 0, rgba(255,122,0,.22) 2px, transparent 2px, transparent 40px);
  background-size:40px 40px; display:flex; flex-direction:column; min-height:100vh;
}
header{display:flex;justify-content:center;padding:12px 12px 0}
h1{
  color:var(--laranja);font-weight:900;font-size:calc(1.6rem + 2pt);margin:0;
  -webkit-text-stroke:1px var(--ouro-velho);
  text-shadow:-1px -1px 0 var(--ouro-velho), 1px -1px 0 var(--ouro-velho),
              -1px  1px 0 var(--ouro-velho), 1px  1px 0 var(--ouro-velho);
}
.wrap{max-width:620px;margin:0 auto;padding:8px 16px 24px;width:100%}
.hero{
  display:block;margin:8px auto 16px;max-width:100%;height:auto;max-height:483px;
  border:6px solid var(--dourado);
  box-shadow:0 0 0 4px var(--laranja) inset, 0 6px 16px var(--sombra);
  border-radius:14px
}
.buttons-wrap{position:relative}
.hint-arrows{
  position:absolute; left:0; right:0; top:-6px; pointer-events:none;
  display:flex; justify-content:space-between; align-items:center; padding:0 4px;
}
.hint{color:var(--vermelho); font-weight:900; font-size:clamp(22px, 3.2vw, 30px); line-height:1;
  animation:hintBlink .9s ease-in-out 2; text-shadow:0 0 6px rgba(0,0,0,.25);}
@keyframes hintBlink{0%{opacity:0;transform:translateY(-3px)}20%{opacity:1;transform:translateY(0)}50%{opacity:0}100%{opacity:0}}
.buttons{display:flex;flex-direction:column;gap:7px;margin-top:8px}
.btn{
  position:relative; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;
  background:rgba(255,255,255,.97); border:4px solid var(--dourado);
  box-shadow:0 0 0 3px var(--laranja) inset, 0 4px 10px var(--sombra);
  border-radius:18px; padding:7.2px 18px; width:77%; margin:0 auto;
  font-size:1rem; font-weight:900; color:var(--laranja); text-decoration:none; text-align:center;
  transition:transform .15s ease, background-color .2s ease
}
.btn:hover{transform:scale(1.02); background:#fff7ec}
.btn[aria-disabled="true"]{opacity:.55; pointer-events:none; cursor:not-allowed}
.btn img{
  position:absolute; left:12px; width:26px; height:26px; object-fit:cover; border-radius:50%;
  border:3px solid var(--dourado); box-shadow:0 0 0 3px var(--laranja) inset;
}
.btn .label{width:100%; text-align:center; pointer-events:none}
.back-wrap{display:flex; justify-content:center; margin-top:8px; transform:scale(.48); transform-origin:center top;}
.btn-back{
  display:inline-flex; align-items:center; gap:10px; background:var(--vermelho); color:#fff; border:none; border-radius:999px;
  padding:10px 16px; font-weight:800; cursor:pointer; box-shadow:0 6px 14px var(--sombra);
}
.btn-back .arr{font-size:18px; line-height:1}
</style>
</head>
<body>

<main class="wrap">
  <header><h1>Anáforas</h1></header>
  <img class="hero" src="img/icone-anafora.jpg" alt="Ícone — Anáforas">

  <div class="buttons-wrap">
    <div class="hint-arrows" id="hintArrows">
      <span class="hint left">↓</span>
      <span class="hint right">↓</span>
    </div>

    <!-- Os 8 botões têm data-key (i0..i7) para ligar com a planilha -->
    <section class="buttons" aria-label="Lista de Anáforas">
      <a class="btn" data-key="i0" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
      <a class="btn" data-key="i1" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
      <a class="btn" data-key="i2" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
      <a class="btn" data-key="i3" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
      <a class="btn" data-key="i4" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
      <a class="btn" data-key="i5" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
      <a class="btn" data-key="i6" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
      <a class="btn" data-key="i7" href="#" target="_blank" rel="noopener"><img src="img/cruz8.jpeg" alt=""><span class="label">—</span></a>
    </section>
  </div>

  <div class="back-wrap">
    <button class="btn-back" type="button" onclick="goBackOrHome()">
      <span class="arr">←</span><span>Voltar</span>
    </button>
  </div>
</main>

<script>
/* ===== CONFIG: link da planilha publicada (aba Anáforas) ===== */
const BASE_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=721498943&single=true&output=csv';

/* Voltar */
function goBackOrHome(){
  try{ if(history.length>1) history.back(); else location.href='index-teste.html'; }
  catch(e){ location.href='index-teste.html'; }
}

/* Some com as setas após piscarem 2x */
document.addEventListener('DOMContentLoaded', ()=>{
  const right = document.querySelector('#hintArrows .right');
  const wrap = document.getElementById('hintArrows');
  if(right && wrap){ right.addEventListener('animationend', ()=>{ wrap.remove(); }, {once:true}); }
});

/* Helpers de normalização */
const norm = s => (s??'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();

/* CSV Parser (aspas/CRLF) */
function parseCSV(text){
  const rows = []; let i=0, field='', row=[], inQ=false;
  while(i<text.length){
    const c = text[i];
    if(inQ){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i+=2; continue; }
        inQ = false; i++; continue;
      } else { field += c; i++; continue; }
    } else {
      if(c === '"'){ inQ = true; i++; continue; }
      if(c === ','){ row.push(field); field=''; i++; continue; }
      if(c === '\n' || c === '\r'){
        if(c === '\r' && text[i+1] === '\n') { i+=2; } else { i++; }
        if(field.length || row.length){ row.push(field); rows.push(row); }
        field=''; row=[]; 
        continue;
      }
      field += c; i++;
    }
  }
  if(field.length || row.length){ row.push(field); rows.push(row); }
  return rows.map(r=>r.map(c=> (c??'').toString().trim() ));
}

/* Ativo: aceita vários valores comuns */
function isActive(val){
  const v = norm(val);
  return (v==='' /* sem coluna ou vazio */) || v==='1' || v==='true' || v==='sim' || v==='yes' || v==='y' || v==='on';
}

/* Fetch com cache-buster e fallback AllOrigins */
async function fetchCSV(url){
  const cb = Math.floor(Date.now()/60000);
  const u = url + (url.includes('?') ? '&' : '?') + 'cb='+cb;
  try{
    const r = await fetch(u, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.text();
  }catch(e){
    const alt = 'https://api.allorigins.win/raw?url='+encodeURIComponent(u);
    const r2 = await fetch(alt, {cache:'no-store'});
    if(!r2.ok) throw new Error('fallback '+r2.status);
    return await r2.text();
  }
}

/* Boot */
(async function(){
  try{
    const csv = await fetchCSV(BASE_CSV);
    const rows = parseCSV(csv).filter(r=> r.some(c=>c && c.trim()!=='') );
    if(!rows.length){ throw new Error('CSV vazio'); }

    const headerRaw = rows[0];
    const header = headerRaw.map(h=> norm(h) );

    // Função que devolve o primeiro índice existente dentre os sinônimos
    const hIdx = (alts)=> {
      const nAlts = alts.map(norm);
      for(const name of nAlts){
        const i = header.indexOf(name);
        if(i>=0) return i;
      }
      return -1;
    };

    // Mapeamento robusto de colunas
    const idx = {
      key:   hIdx(['key','chave','i','indice','índice']),
      rotulo:hIdx(['rótulo','rotulo','label','titulo','título','nome']),
      link:  hIdx(['link_doc','link','url','href','arquivo','doc']),
      ativo: hIdx(['ativo','enabled','publicado','ativo?']),
      ordem: hIdx(['ordem','order','pos'])
    };

    if(idx.key<0){
      throw new Error('Coluna "key" (i0..i7) não encontrada. Aceitos: key/chave/i/indice/índice.');
    }
    if(idx.link<0 && idx.rotulo<0){
      throw new Error('Cabeçalhos não encontrados: link (link_doc/link/url) e rótulo (rótulo/label/título).');
    }

    // Monta mapa por key (i0..i7)
    const map = {};
    rows.slice(1).forEach(r=>{
      const k = (idx.key>=0 ? r[idx.key] : '').trim();
      if(!k) return;
      const label = (idx.rotulo>=0 ? r[idx.rotulo] : '').trim();
      const href  = (idx.link>=0   ? r[idx.link]   : '').trim();
      const ativo = (idx.ativo>=0  ? r[idx.ativo]  : '');
      const order = (idx.ordem>=0  ? parseInt(r[idx.ordem]||'0',10) : 0);
      map[k] = { label, href, ativo, order };
    });

    // Aplica nos botões existentes
    const btns = Array.from(document.querySelectorAll('.btn[data-key]'));
    // Se quiser respeitar "ordem", pode reordenar aqui:
    // btns.sort((a,b)=> (map[a.dataset.key]?.order ?? 0) - (map[b.dataset.key]?.order ?? 0))
    // const container = document.querySelector('.buttons'); btns.forEach(b=>container.appendChild(b));

    btns.forEach(a=>{
      const key = a.getAttribute('data-key');
      const data = map[key];
      const labelEl = a.querySelector('.label');

      if(!data){
        a.href = '#';
        a.setAttribute('aria-disabled','true');
        a.title = 'Não encontrado na planilha';
        labelEl.textContent = '—';
        return;
      }

      // Rótulo
      labelEl.textContent = data.label || '—';

      // Estado/link
      const ativoOk = isActive(data.ativo);
      const hasLink = !!data.href;
      if((idx.ativo<0 && hasLink) || (ativoOk && hasLink)){
        a.href = data.href;
        a.setAttribute('aria-disabled','false');
        a.title = 'Abrir documento';
      }else{
        a.href = '#';
        a.setAttribute('aria-disabled','true');
        a.title = 'Item desativado';
      }
    });

    // Logs úteis
    console.log('[anáforas] header:', headerRaw);
    console.log('[anáforas] mapeado keys:', Object.keys(map));

  }catch(err){
    console.error('Falha ao carregar a planilha de Anáforas:', err);
    document.querySelectorAll('.btn[data-key]').forEach(a=>{
      a.href = '#'; a.setAttribute('aria-disabled','true'); a.title = 'Erro ao carregar dados';
      const labelEl = a.querySelector('.label'); if(labelEl) labelEl.textContent = '—';
    });
  }
})();
</script>
</body>
</html>

