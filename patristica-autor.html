<!-- patristica-autor.html — página de autor: lê apenas patristica-links e monta os 4 botões -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Patrística — Autor</title>
<style>
:root{--areia-clara:#efe1c7;--areia-media:#e6d6b4;--areia-escura:#c2a772;--ouro:#b4923a;--preto:#111;--shadow:rgba(0,0,0,.18);--sans:Arial,Helvetica,sans-serif;--vermelho:#a00000;}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:var(--sans); color:#2b2114;
  background:
    radial-gradient(1px 1px at 15% 25%, rgba(255,255,255,.8), transparent 60%),
    radial-gradient(1px 1px at 75% 12%, rgba(255,255,255,.75), transparent 60%),
    radial-gradient(1px 1px at 55% 70%, rgba(255,255,255,.7), transparent 60%),
    radial-gradient(1px 1px at 28% 58%, rgba(255,255,255,.8), transparent 60%),
    linear-gradient(to top, var(--areia-escura), var(--areia-media), var(--areia-clara));
  display:flex; flex-direction:column; min-height:100vh;
}
.wrap{max-width:640px;margin:0 auto;padding:12px 16px 22px;width:100%}
.title{
  text-align:center; font-size:calc(1.9rem + 3pt); font-weight:900; color:var(--preto);
  text-shadow:-1px -1px 0 var(--ouro), 1px -1px 0 var(--ouro),
              -1px  1px 0 var(--ouro), 1px  1px 0 var(--ouro);
  margin-bottom:8px;
}
.hero{
  display:block;margin:8px auto 16px; max-width:100%;
  width:100%; height:260px; object-fit:contain;
  border:6px solid var(--ouro); border-radius:40% / 18%;
  box-shadow:0 8px 18px var(--shadow); background:#fff7e6;
}
.subtitle{ text-align:center; font-weight:800; margin-bottom:6px }
.actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;width:100%}
.actionBtn{
  display:flex;align-items:center;justify-content:center;text-align:center;min-height:64px;
  padding:12px;border-radius:14px;text-decoration:none;background:#fff;color:#2b2114;font-weight:800;
  border:3px solid var(--ouro);box-shadow:inset 0 0 0 3px rgba(180,146,58,.45),0 3px 8px var(--shadow)
}
.actionBtn[aria-disabled="true"]{opacity:.45;pointer-events:none}
.toolbar{display:flex;justify-content:center;gap:8px;margin:6px 0 4px}
.small{font-size:.8rem;border:2px dashed #b97a00;background:#fff7e0;color:#7a5200;border-radius:8px;padding:.25rem .5rem;cursor:pointer}
.alert{margin:10px auto;width:90%;max-width:520px;background:#fff3cd;color:#7c5b00;border:1px solid #ffe08a;padding:6px 10px;font-size:.9rem;border-radius:8px;text-align:center;display:none}
footer{ margin-top:auto; padding:16px 0 36px; text-align:center }
.voltar{
  background:var(--vermelho); color:#fff; font-size:.65rem; font-weight:bold;
  border:none; border-radius:6px; padding:.3rem .55rem; cursor:pointer;
  display:inline-flex; align-items:center; gap:.4rem; text-decoration:none;
  transform:scale(0.6); transform-origin:center;
}
.voltar:hover{background:#c00000}
</style>
</head>
<body>
  <main class="wrap">
    <h1 id="title" class="title">Patrística — Autor</h1>
    <img id="hero" class="hero" src="img/icone-patristica.png" alt="Autor">
    <div id="alert" class="alert"></div>

    <div class="toolbar">
      <button class="small" onclick="trocarAutor()">Alterar autor…</button>
    </div>

    <div id="subtitle" class="subtitle"></div>

    <section id="actions" class="actions" aria-label="Links do autor"></section>
  </main>

  <footer>
    <a class="voltar" href="javascript:history.back()">&#8592; Voltar</a>
  </footer>

<script>
// ====== CONFIG ======
var CSV_LINKS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=101845558&single=true&output=csv";
var BUTTON_ORDER = ['biografia','homilias','hinos','obras'];
var LABELS = { biografia:'Biografia', homilias:'Homilias', hinos:'Hinos', obras:'Obras selecionadas' };

// Nome e ícone por slug (evita depender da aba problemático do “autores”)
var AUTHOR_META = {
  'santo-efrem':        {name:'Santo Efrém',        icon:'img/efrem.png'},
  'narsai-de-nisibis':  {name:'Narsai de Nisibis',  icon:'img/narsai-nisibis.png'},
  'jaco-de-serugh':     {name:'Jacó de Serugh',     icon:'img/jaco-serugh.png'},
  'isaque-de-ninive':   {name:'Isaque de Nínive',   icon:'img/isaque-ninive.jpeg'}
};

// ====== HELPERS ======
function getSlug(){
  var h=(location.hash||'').replace(/^#/,'').trim();
  if(h) return h;
  // fallback: procura ?a=slug
  var m=location.search.match(/[?&]a=([^&]+)/i);
  return m ? decodeURIComponent(m[1]) : 'santo-efrem';
}
function trocarAutor(){
  var atual = getSlug();
  var lista = Object.keys(AUTHOR_META);
  var dest = prompt('Digite o slug do autor:\n' + lista.join('\n'), atual);
  if(dest && AUTHOR_META[dest]){ location.hash = dest; location.reload(); }
}

// CSV parse (simples e confiável para Google Sheets)
function parseCSV(text){
  text = (text||'').replace(/^\uFEFF/,'');
  var lines = text.split(/\r?\n/).filter(function(l){return l.trim()!==''});
  var rows=[];
  for(var li=0; li<lines.length; li++){
    var line=lines[li], cur='', q=false, row=[];
    for(var i=0;i<line.length;i++){
      var c=line[i];
      if(c=='"'){ if(q && line[i+1]=='"'){ cur+='"'; i++; } else { q=!q; } }
      else if(c===',' && !q){ row.push(cur); cur=''; }
      else { cur+=c; }
    }
    row.push(cur);
    rows.push(row.map(function(x){return x.trim();}));
  }
  return rows;
}
function normHeader(h){
  if(!h) return '';
  var s=(''+h).toLowerCase();
  if(s.normalize){ s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  s=s.replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  return s;
}

// ====== RENDER ======
var titleEl=document.getElementById('title');
var subtitleEl=document.getElementById('subtitle');
var hero=document.getElementById('hero');
var actions=document.getElementById('actions');
var alertBx=document.getElementById('alert');

function renderAuthorHeader(slug){
  var meta = AUTHOR_META[slug] || {name:slug, icon:'img/icone-patristica.png'};
  titleEl.textContent = meta.name;
  subtitleEl.textContent = meta.name;
  hero.src = meta.icon;
  hero.alt = meta.name;
}

function buildButtonsFor(slug, rows){
  actions.innerHTML='';
  // mapear cabeçalho
  var head = rows[0]||[];
  var map={}; for(var i=0;i<head.length;i++) map[normHeader(head[i])]=i;
  // filtrar linhas do autor
  var data = rows.slice(1).filter(function(r){
    return (r[map.author_slug]||'').trim()===slug;
  });
  // montar estrutura key -> {label,url,enabled}
  var byKey = {};
  for(var i=0;i<data.length;i++){
    var r=data[i];
    var key=((r[map.button_key]||'')+'').toLowerCase().trim();
    if(!key) continue;
    byKey[key] = {
      label:(r[map.label]||LABELS[key]||key),
      url:(r[map.url]||''),
      enabled:String(r[map.enabled]||'1').trim()
    };
  }
  // criar botões na ordem
  BUTTON_ORDER.forEach(function(key){
    var d = byKey[key] || {label:LABELS[key], url:'', enabled:'0'};
    var A=document.createElement('a');
    A.className='actionBtn';
    A.textContent=d.label||LABELS[key]||key;
    var on=d.url && d.enabled==='1';
    if(on){ A.href=d.url; A.target='_blank'; A.rel='noopener'; }
    else{ A.href='#'; A.setAttribute('aria-disabled','true'); }
    actions.appendChild(A);
  });

  // alerta se não encontrou nada
  var total = Object.keys(byKey).length;
  if(!total){
    alertBx.textContent='Nenhum link encontrado para este autor na aba "patristica-links".';
    alertBx.style.display='block';
  }else{
    alertBx.style.display='none';
  }
}

// ====== BOOT ======
(function init(){
  var slug = getSlug();
  renderAuthorHeader(slug);

  // traz apenas patristica-links
  fetch(CSV_LINKS + '&t=' + Date.now(), {cache:'no-store'})
    .then(function(res){ if(!res.ok) throw new Error(res.status); return res.text(); })
    .then(function(txt){
      var rows = parseCSV(txt);
      if(!rows.length) throw new Error('CSV vazio');
      buildButtonsFor(slug, rows);
    })
    .catch(function(err){
      alertBx.textContent='Erro ao carregar links: ' + err;
      alertBx.style.display='block';
    });
})();
</script>
</body>
</html>
