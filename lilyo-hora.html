<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lilyo — Vigílias</title>
<meta name="theme-color" content="#020814">
<style>
  :root{ --fundo:#020814; --dourado:#d6b25a; --bege-escuro:#e8d6ad; --vermelho:#a00000; --sombra:rgba(0,0,0,.22); }
  body{ margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:var(--fundo); position:relative; overflow-x:hidden; min-height:100vh; display:flex; flex-direction:column;}
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(1px 1px at 6% 8%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 10% 18%, rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 14% 28%, rgba(255,255,255,.75)99%, transparent 100%),
      radial-gradient(1px 1px at 18% 10%, rgba(255,255,255,.85)99%, transparent 100%),
      radial-gradient(1px 1px at 22% 22%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 26% 6%,  rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 30% 16%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 34% 30%, rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 40% 12%, rgba(255,255,255,.85)99%, transparent 100%),
      radial-gradient(1px 1px at 46% 24%, rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 52% 18%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 58% 8%,  rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 64% 22%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 70% 14%, rgba(255,255,255,.75)99%, transparent 100%),
      radial-gradient(1px 1px at 76% 28%, rgba(255,255,255,.85)99%, transparent 100%),
      radial-gradient(1px 1px at 82% 10%, rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 88% 20%, rgba(255,255,255,.85)99%, transparent 100%),
      radial-gradient(1px 1px at 8% 58%,  rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 16% 72%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 24% 86%, rgba(255,255,255,.75)99%, transparent 100%),
      radial-gradient(1px 1px at 32% 64%, rgba(255,255,255,.85)99%, transparent 100%),
      radial-gradient(1px 1px at 40% 78%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 48% 90%, rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 56% 68%, rgba(255,255,255,.85)99%, transparent 100%),
      radial-gradient(1px 1px at 64% 82%, rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(1px 1px at 72% 70%, rgba(255,255,255,.9) 99%, transparent 100%),
      radial-gradient(1px 1px at 80% 86%, rgba(255,255,255,.8) 99%, transparent 100%),
      radial-gradient(450px 450px at 50% 40%, rgba(255,255,255,.05), transparent 70%),
      radial-gradient(300px 300px at 20% 60%, rgba(255,255,255,.04), transparent 70%),
      radial-gradient(300px 300px at 80% 70%, rgba(255,255,255,.04), transparent 70%), transparent;
  }
  .sky-border,.stars-sides{ position:fixed; inset:0; pointer-events:none; z-index:0; }
  .sky-border{ background:
      radial-gradient(3px 3px at 2% 2%,   #fff, transparent 60%),
      radial-gradient(3px 3px at 15% 2%,  #fff, transparent 60%),
      radial-gradient(3px 3px at 50% 2%,  #fff, transparent 60%),
      radial-gradient(3px 3px at 85% 2%,  #fff, transparent 60%),
      radial-gradient(3px 3px at 98% 2%,  #fff, transparent 60%),
      radial-gradient(3px 3px at 2% 20%,  #fff, transparent 60%),
      radial-gradient(3px 3px at 2% 80%,  #fff, transparent 60%),
      radial-gradient(3px 3px at 98% 25%, #fff, transparent 60%),
      radial-gradient(3px 3px at 98% 75%, #fff, transparent 60%),
      radial-gradient(3px 3px at 2% 98%,  #fff, transparent 60%),
      radial-gradient(3px 3px at 15% 98%, #fff, transparent 60%),
      radial-gradient(3px 3px at 50% 98%, #fff, transparent 60%),
      radial-gradient(3px 3px at 85% 98%, #fff, transparent 60%),
      radial-gradient(3px 3px at 98% 98%, #fff, transparent 60%);
    filter:drop-shadow(0 0 11px rgba(255,255,255,1)) drop-shadow(0 0 24px rgba(255,255,255,.7));
  }
  .stars-sides{ background:
      radial-gradient(5px 5px at 1% 38%,  #fff, transparent 60%),
      radial-gradient(5px 5px at 1% 62%,  #fff, transparent 60%),
      radial-gradient(5px 5px at 99% 30%, #fff, transparent 60%),
      radial-gradient(5px 5px at 99% 70%, #fff, transparent 60%),
      radial-gradient(4px 4px at 3% 80%,  #fff, transparent 60%),
      radial-gradient(4px 4px at 97% 20%, #fff, transparent 60%);
    filter:drop-shadow(0 0 14px rgba(255,255,255,1)) drop-shadow(0 0 28px rgba(255,255,255,.8));
  }
  .moon{
    position:fixed; top:-13.5vh; left:50%; transform:translateX(-50%);
    width:27vh; height:27vh; border-radius:50%; pointer-events:none; z-index:0;
    box-sizing:border-box; padding:20px;
    background:
      radial-gradient(circle at 35% 35%, #ffffff 0%, #f7f0d6 55%, #e6dfc2 75%, rgba(255,255,255,0) 76%),
      radial-gradient(6px 6px at 42% 38%, rgba(0,0,0,.16), rgba(0,0,0,0) 60%),
      radial-gradient(4px 4px at 30% 48%, rgba(0,0,0,.12), rgba(0,0,0,0) 60%),
      radial-gradient(5px 5px at 52% 30%, rgba(0,0,0,.10), rgba(0,0,0,0) 60%),
      linear-gradient(#ffffff, #ffffff);
    background-clip: content-box, content-box, content-box, content-box, padding-box;
    box-shadow: 0 0 0 2px #c0c0c0, 0 0 22px 9px rgba(255,255,255,.26), inset 0 0 46px rgba(255,255,255,.16);
  }

  header{ position:relative; z-index:1; text-align:center; padding:6px 12px 0 }
  .titulo{ margin:0; padding:0; line-height:1.05; font-weight:900; letter-spacing:.6px; font-size:37px; color:#fff; -webkit-text-stroke:3px var(--dourado); text-shadow:0 1px 0 rgba(0,0,0,.25); }
  .subtitulo{ margin:2px 0 4px; line-height:1.08; font-size:20px; color:var(--bege-escuro); font-weight:800; }
  .hero-oval{
    display:block; margin:clamp(8px, 10vh, 140px) auto 10px; width:min(85vw, 544px); aspect-ratio:3/4; border-radius:38% / 50%;
    border:6px solid var(--dourado); overflow:hidden; box-shadow:0 6px 18px var(--sombra); position:relative; z-index:1; background:#000;
  }
  .hero-oval .hero-img{ width:100%; height:100%; object-fit:cover; object-position:50% 45%; display:block; border:0; }

  .wrap{ position:relative; z-index:1; max-width:600px; margin:0 auto; padding:14px 20px 12px; display:flex; flex-direction:column; align-items:center; gap:12px; flex:1; }
  .btn{
    position:relative; display:flex; align-items:center; justify-content:flex-start; text-decoration:none; background:#fff;
    border:2px solid var(--dourado); border-radius:14px; width:55%; min-width:280px; min-height:34px; padding:4px 12px;
    box-shadow:0 4px 10px var(--sombra); color:#000; text-align:center; font-weight:800; transition:transform .08s, box-shadow .12s; overflow:hidden; margin:0 auto;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 14px var(--sombra); }
  .btn .icon-round{ width:32px; height:32px; border-radius:50%; object-fit:cover; border:2px solid var(--dourado); box-shadow:0 0 0 2px #fff inset; background:#fff; margin-right:10px; flex:0 0 auto; }
  .btn .label{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .btn .main{ font-size:21px; line-height:1.06; -webkit-text-stroke:.8px var(--dourado); }

  footer{ text-align:center; margin:10px 0 22px; position:relative; z-index:1; }
  .btn-voltar{
    display:inline-flex; align-items:center; gap:8px; background:var(--vermelho); color:#fff; text-decoration:none;
    border:none; border-radius:999px; padding:6px 12px; font-weight:800; font-size:12px; box-shadow:0 3px 8px var(--sombra); transform:scale(.6); transform-origin:center;
  }
  #toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#222; color:#fff; padding:9px 14px; border-radius:10px; font-size:.9rem; opacity:0; pointer-events:none; transition:.2s}
</style>
</head>
<body>
  <div class="sky-border" aria-hidden="true"></div>
  <div class="stars-sides" aria-hidden="true"></div>
  <div class="moon" aria-hidden="true"></div>

  <header>
    <h1 class="titulo">Lilyo</h1>
    <div class="subtitulo">meia-noite e vigílias</div>
    <figure class="hero-oval"><img class="hero-img" src="img/icone-lilyo.horas.jpg" alt="Ícone principal Lilyo" onerror="this.src='img/cedro.jpg'"></figure>
  </header>

  <main class="wrap">
    <div id="col"></div>
  </main>

  <footer>
    <a class="btn-voltar" id="backLink" href="horas-teste.html">← voltar</a>
  </footer>

  <div id="toast"></div>

<script>
/* ====== CONFIG ====== */
const SHEET_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vTSNOwDCcQPyPihUkD8PbrtAmMjV9gcYgCmOXNnAfK6chO41qAAtltEpzl-mlxEvlnMwGQQ-JgKjMI3/pub?gid=970478871&single=true&output=csv';
const PAGE_SLUG='lilyo';

/* ====== HELPERS ====== */
const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();

function parseCSV(t){
  const r=[];let i=0,c=[],v='',q=false;
  while(i<t.length){
    const ch=t[i++];
    if(q){
      if(ch=='"'&&t[i]=='"'){v+='"';i++;}
      else if(ch=='"'){q=false;}
      else v+=ch;
    }else{
      if(ch===','){c.push(v);v='';}
      else if(ch=='"'){q=true;}
      else if(ch=='\n'){c.push(v);r.push(c);c=[];v='';}
      else if(ch!=='\r'){v+=ch;}
    }
  }
  if(v.length||c.length){c.push(v);r.push(c);}
  return r;
}

async function fetchCSV(u){
  const cb=Math.floor(Date.now()/60000);
  const u1=u+(u.includes('?')?'&':'?')+'cb='+cb;
  try{
    const r=await fetch(u1);
    if(!r.ok)throw new Error(r.status);
    return await r.text();
  }catch(e){
    const p='https://api.allorigins.win/raw?url='+encodeURIComponent(u1);
    const r=await fetch(p);
    if(!r.ok)throw new Error('fallback '+r.status);
    return await r.text();
  }
}

// ACEITA DDMMAAAA / DD/MM/AAAA / AAAA-MM-DD etc.
function toISOfromCSV(val){
  const s=(val||'').toString().trim();
  if(!s) return null;

  if(/^\d{8}$/.test(s)){
    const dd=s.slice(0,2), mm=s.slice(2,4), yyyy=s.slice(4,8);
    return `${yyyy}-${mm}-${dd}`;
  }

  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  const t=s.replace(/[-.]/g,'/');
  const p=t.split('/');
  if(p.length===3){
    if(p[0].length===4){
      const[y,m,d]=p;
      return`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    const[d,m,y]=p;
    return`${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }
  return null;
}

function todayISO(){
  const d=new Date(),y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function q(name){return new URLSearchParams(location.search).get(name)}
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.opacity=1;
  clearTimeout(window.__tid);window.__tid=setTimeout(()=>t.style.opacity=0,2200);
}

/* ====== UI ====== */
function mkBtn(label, subtitle, url){
  const a=document.createElement('a'); a.className='btn'; a.href=url||'#'; a.target='_blank';
  if(!url){a.style.opacity='.45'; a.style.pointerEvents='none';}
  a.innerHTML = `<img class="icon-round" src="img/cedro.jpg" alt="">
                 <span class="label"><span class="main">${label||''}</span>${subtitle?`<span class="sub">${subtitle}</span>`:''}</span>`;
  return a;
}

/* ====== BOOT ====== */
(async function(){
  const raw = q('d') || q('data');
  const iso = raw ? (toISOfromCSV(raw) || todayISO()) : todayISO();

  document.getElementById('backLink').href=`horas-teste.html?d=${iso}`;

  try{
    const txt=await fetchCSV(SHEET_URL);
    const rows=parseCSV(txt).filter(r=>r.join('').trim()!=='');
    const head=rows.shift().map(h=>norm(h));
    const idx=nms=>nms.map(n=>head.indexOf(norm(n))).find(i=>i>=0);

    const iDate=idx(['date','data','dia']);
    const iSlug=idx(['page_slug','pagina','page']);
    const iLab =idx(['label','rotulo','rótulo']);
    const iSub =idx(['subtitle','subtitulo','subtítulo']);
    const iUrl =idx(['url','link','doc','arquivo']);
    const iOrd =idx(['order','ordem','pos']);
    const iEn  =idx(['enabled','ativo','publicado']);

    let list=rows.filter(r=>norm(r[iSlug])===norm(PAGE_SLUG) && (iEn<0 || String(r[iEn]||'1').trim()!=='0'));

    const todayRows = list.filter(r=>{
      if(iDate<0) return false;
      const isoRow = toISOfromCSV((r[iDate]||'').trim());
      return isoRow === iso;
    });

    list = todayRows.length ? todayRows : list.filter(r=> iDate<0 || (r[iDate]||'').trim()==='');
    list.sort((a,b)=>(parseInt(a[iOrd]||0)-parseInt(b[iOrd]||0)));

    const col=document.getElementById('col');
    if(!list.length){ toast('Nenhum link disponível para a data.'); }
    list.forEach(r=> col.appendChild(mkBtn(r[iLab], r[iSub], r[iUrl])) );
  }catch(e){
    console.error(e);
    toast('Erro ao carregar planilha');
  }
})();
</script>
</body>
</html>
